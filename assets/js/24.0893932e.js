(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{341:function(e,t,o){"use strict";o.r(t);var a=o(6),r=Object(a.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("p",[e._v("BDK relies heavily on the Miniscript language to support arbitrary output descriptors seamlessly.")]),e._v(" "),t("p",[e._v("The Miniscript compiler models arbitrary spending policies and generates an optimized bitcoin script that enforces said policies when executed in the bitcoin network.")]),e._v(" "),t("p",[e._v("Recently a bug has been discovered in the Miniscript type system, which can cause an unsafe bitcoin script to be generated in some cases, described in detail below. Affected UTXOs can be spent by malicious\nminers without providing any valid signature, effectively bypassing all the signature checks in the script.")]),e._v(" "),t("p",[e._v("We analyzed mainnet blocks starting from the beginning of 2020 and "),t("strong",[e._v("found no transaction spending from a script which is affected by this bug")]),e._v(", which leads us to believe that nobody is currenly using this\nstructure in production. Nonetheless, we still recommend upgrading as soon as possible.")]),e._v(" "),t("h2",{attrs:{id:"how-to-check-if-you-are-vulnerable"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#how-to-check-if-you-are-vulnerable"}},[e._v("#")]),e._v(" How to check if you are vulnerable")]),e._v(" "),t("p",[e._v("As a rule of thumb, if your descriptor contains a "),t("code",[e._v("thresh()")]),e._v(" with either an "),t("code",[e._v("older()")]),e._v(" or "),t("code",[e._v("after()")]),e._v(" inside, then you are probably vulnerable.")]),e._v(" "),t("p",[e._v("Specifically, the following conditions must be met for a descriptor to be vulnerable:")]),e._v(" "),t("ol",[t("li",[t("code",[e._v("thresh")]),e._v(" fragment.")]),e._v(" "),t("li",[t("code",[e._v("older")]),e._v(" or "),t("code",[e._v("after")]),e._v(" must be a direct child.")]),e._v(" "),t("li",[t("code",[e._v("older")]),e._v(" must have a wrapper "),t("code",[e._v("d:")]),e._v(" around it.")])]),e._v(" "),t("p",[e._v("Moreover, for a miner to be able to steal the funds from a vulnerable script, the timelock (relative or absolute) must be expired.")]),e._v(" "),t("p",[e._v("For example, the descriptor shown in our "),t("a",{attrs:{href:"/blog/2021/02/spending-policy-demo"}},[e._v("previous blog post")]),e._v(", "),t("code",[e._v("wsh(thresh(3,pk(Alice),s:pk(Bob),s:pk(Carol),sdv:older(2)))")]),e._v(", is actually affected by this vulnerability because it uses a "),t("code",[e._v("thresh()")]),e._v("\ncontaining an "),t("code",[e._v("older()")]),e._v(" with "),t("code",[e._v("sdv:")]),e._v(" wrappers (which is just a shorthand for "),t("code",[e._v("s: d: v:")]),e._v(").")]),e._v(" "),t("p",[e._v("For the technical details check out the "),t("a",{attrs:{href:"https://github.com/rust-bitcoin/rust-miniscript/blob/70191e5a32f7c072d32476ba0b8861ca57af3df8/doc/security_report_2022_04_20.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("security advisory"),t("OutboundLink")],1),e._v(" published by the maintainer of "),t("code",[e._v("rust-miniscript")]),e._v(".")]),e._v(" "),t("h2",{attrs:{id:"next-steps"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#next-steps"}},[e._v("#")]),e._v(" Next steps")]),e._v(" "),t("h3",{attrs:{id:"if-you-are-affected"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#if-you-are-affected"}},[e._v("#")]),e._v(" If you are affected")]),e._v(" "),t("p",[e._v("If you are affected by the vulnerability, "),t("strong",[e._v("DO NOT SPEND THE FUNDS")]),e._v(", as they could be stolen by a malicious miner.")]),e._v(" "),t("p",[e._v("We are in contact with a large mining pool that could include your transaction directly without broadcasting it to the network: contact us and we'll help you out.")]),e._v(" "),t("h3",{attrs:{id:"everybody"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#everybody"}},[e._v("#")]),e._v(" Everybody")]),e._v(" "),t("p",[e._v("Even if you are not affected please update BDK, or at least "),t("code",[e._v("rust-miniscript")]),e._v(" as soon as possible.")]),e._v(" "),t("p",[e._v("BDK version "),t("code",[e._v("0.18.0")]),e._v(", released on April 20, addresses this issue by requiring the fixed "),t("code",[e._v("6.1.x")]),e._v(" version of "),t("code",[e._v("rust-miniscript")]),e._v(". If you need to stay on an older version of BDK, you can run "),t("code",[e._v("cargo update")]),e._v(" to update "),t("code",[e._v("rust-miniscript")]),e._v(" to one\nof the non-vulnerable versions:")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("6.1.0")])]),e._v(" "),t("li",[t("code",[e._v("5.2.0")])]),e._v(" "),t("li",[t("code",[e._v("4.1.0")])]),e._v(" "),t("li",[t("code",[e._v("3.1.0")])]),e._v(" "),t("li",[t("code",[e._v("2.1.0")])]),e._v(" "),t("li",[t("code",[e._v("1.1.0")])])]),e._v(" "),t("h2",{attrs:{id:"consequences-of-the-update"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#consequences-of-the-update"}},[e._v("#")]),e._v(" Consequences of the update")]),e._v(" "),t("p",[e._v("Since this bug is in the bitcoin script produced by Miniscript, fixing the vulnerabiliy will also make the bitcoin script change: this means that if you don't see your funds in your wallet after the update\nyour script was vulnerable to this bug. Contact us for help sweeping the funds from the old to the newer script.")]),e._v(" "),t("p",[e._v("Also, if your wallet considers a previously-valid descriptor invalid, it also meant it was vulnerable. It can generally be fixed by adding a "),t("code",[e._v("n:")]),e._v(" wrapper to the timelock (i.e. "),t("code",[e._v("sdv:older()")]),e._v(" would become "),t("code",[e._v("sndv:older()")]),e._v("),\nbut that will cause your script to change.")]),e._v(" "),t("p",[e._v("If you were not using a vulnerable script, then nothing should change for you. Please file an issue if you notice other problems after the upgrade.")]),e._v(" "),t("h2",{attrs:{id:"footnote-how-we-analyzed-the-blockchain"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#footnote-how-we-analyzed-the-blockchain"}},[e._v("#")]),e._v(" Footnote: How we analyzed the blockchain")]),e._v(" "),t("p",[e._v("We used the "),t("a",{attrs:{href:"https://github.com/RCasatta/blocks_iterator",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("blocks_iterator")]),t("OutboundLink")],1),e._v(" crate to analyze bitcoin blocks starting from early 2020 (initial release date of miniscript) looking for transactions spending from vulnerable scripts.\nThe tool we used has been "),t("a",{attrs:{href:"https://github.com/afilini/miniscript-bug-check-blocks",target:"_blank",rel:"noopener noreferrer"}},[e._v("published on GitHub"),t("OutboundLink")],1),e._v(" and can be run by anyone who wants to verify our claim.")]),e._v(" "),t("p",[e._v("We would like to thank "),t("a",{attrs:{href:"https://github.com/sanket1729",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("sanket1729")]),t("OutboundLink")],1),e._v(" and "),t("a",{attrs:{href:"https://github.com/RCasatta",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("RCasatta")]),t("OutboundLink")],1),e._v(" for their help implementing and running the tool on the bitcoin mainnet blockchain.")]),e._v(" "),t("h2",{attrs:{id:"correction-2022-04-25"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#correction-2022-04-25"}},[e._v("#")]),e._v(" Correction (2022-04-25)")]),e._v(" "),t("p",[e._v("By re-running the tool on the mainnet blockchain for a second time we were able to find one vulnerable output, created and spent a long time ago (around the initial announcement and release date of Miniscript).")]),e._v(" "),t("p",[e._v("The amount was negligible, so we believe this was a small test performed by somebody to play with Miniscript.")])])}),[],!1,null,null,null);t.default=r.exports}}]);