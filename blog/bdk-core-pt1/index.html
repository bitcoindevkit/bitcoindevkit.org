<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>`bdk_core`: a new architecture for the Bitcoin Dev Kit | Bitcoin Dev Kit Documentation</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="preload" href="/fonts/ibm-plex-mono-400.woff2" as="font" crossorigin="true">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="/css/variables.css">
    <link name="msapplication-config" content="/browserconfig.xml">
    <link name="msapplication-TileColor" content="#ffffff">
    <link name="theme-color" content="#ffffff">
    <meta name="description" content="A new architecture for the Bitcoin Dev Kit">
    <meta property="article:published_time" content="2022-05-09T00:00:00.000Z">
    <meta property="og:site_name" content="Bitcoin Dev Kit Documentation">
    <meta property="og:title" content="bdk_core: a new architecture for the Bitcoin Dev Kit">
    <meta property="og:description" content="A new architecture for the Bitcoin Dev Kit">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://bitcoindevkit.org/_blog/bdk_core_pt1/">
    <meta property="og:image" content="https://bitcoindevkit.org/card.png">
    <meta name="twitter:title" content="bdk_core: a new architecture for the Bitcoin Dev Kit">
    <meta name="twitter:description" content="A new architecture for the Bitcoin Dev Kit">
    <meta name="twitter:url" content="https://bitcoindevkit.org/_blog/bdk_core_pt1/">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="https://bitcoindevkit.org/card.png">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="architecture">
    <meta property="article:tag" content="architecture">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    
    <link rel="preload" href="/assets/css/0.styles.d0e837cb.css" as="style"><link rel="preload" href="/assets/js/app.2ad4e539.js" as="script"><link rel="preload" href="/assets/js/4.421e1146.js" as="script"><link rel="preload" href="/assets/js/1.519cc26e.js" as="script"><link rel="preload" href="/assets/js/34.40447606.js" as="script"><link rel="prefetch" href="/assets/js/10.13eb2570.js"><link rel="prefetch" href="/assets/js/11.1a9d756a.js"><link rel="prefetch" href="/assets/js/12.099952e0.js"><link rel="prefetch" href="/assets/js/16.3dfe9d52.js"><link rel="prefetch" href="/assets/js/17.0755a2b9.js"><link rel="prefetch" href="/assets/js/18.19b51f0b.js"><link rel="prefetch" href="/assets/js/19.13924d29.js"><link rel="prefetch" href="/assets/js/2.9f0b68aa.js"><link rel="prefetch" href="/assets/js/20.2e10f8ab.js"><link rel="prefetch" href="/assets/js/21.2e28cab5.js"><link rel="prefetch" href="/assets/js/22.254320de.js"><link rel="prefetch" href="/assets/js/23.6ffea0dd.js"><link rel="prefetch" href="/assets/js/24.1e20990d.js"><link rel="prefetch" href="/assets/js/25.029e16c5.js"><link rel="prefetch" href="/assets/js/26.d6bc6d26.js"><link rel="prefetch" href="/assets/js/27.4781c958.js"><link rel="prefetch" href="/assets/js/28.a211e143.js"><link rel="prefetch" href="/assets/js/29.094122b5.js"><link rel="prefetch" href="/assets/js/3.55a6475d.js"><link rel="prefetch" href="/assets/js/30.cc2bbcfa.js"><link rel="prefetch" href="/assets/js/31.c4152f8b.js"><link rel="prefetch" href="/assets/js/32.4501c742.js"><link rel="prefetch" href="/assets/js/33.ebb81ce2.js"><link rel="prefetch" href="/assets/js/35.363b21cc.js"><link rel="prefetch" href="/assets/js/36.3e431550.js"><link rel="prefetch" href="/assets/js/37.87c3a0a8.js"><link rel="prefetch" href="/assets/js/38.8fd5c156.js"><link rel="prefetch" href="/assets/js/39.890e1f25.js"><link rel="prefetch" href="/assets/js/40.5f4c9ecf.js"><link rel="prefetch" href="/assets/js/41.c9b4a6b0.js"><link rel="prefetch" href="/assets/js/42.9bb9fe04.js"><link rel="prefetch" href="/assets/js/43.ee88bf0c.js"><link rel="prefetch" href="/assets/js/44.8ac835f0.js"><link rel="prefetch" href="/assets/js/45.f6b985ac.js"><link rel="prefetch" href="/assets/js/46.72f5faf5.js"><link rel="prefetch" href="/assets/js/47.1e361a05.js"><link rel="prefetch" href="/assets/js/48.07054ce8.js"><link rel="prefetch" href="/assets/js/49.5320af3f.js"><link rel="prefetch" href="/assets/js/5.eaa248e0.js"><link rel="prefetch" href="/assets/js/50.c97a7934.js"><link rel="prefetch" href="/assets/js/51.0ae6dde9.js"><link rel="prefetch" href="/assets/js/52.ebdd40a3.js"><link rel="prefetch" href="/assets/js/53.a7abe807.js"><link rel="prefetch" href="/assets/js/54.0b50b8ea.js"><link rel="prefetch" href="/assets/js/55.d6cd14f7.js"><link rel="prefetch" href="/assets/js/56.31c5a194.js"><link rel="prefetch" href="/assets/js/57.32590f3e.js"><link rel="prefetch" href="/assets/js/58.4f71c2e5.js"><link rel="prefetch" href="/assets/js/59.8a5db9bc.js"><link rel="prefetch" href="/assets/js/6.4b495eed.js"><link rel="prefetch" href="/assets/js/60.57fd8aed.js"><link rel="prefetch" href="/assets/js/61.05c99932.js"><link rel="prefetch" href="/assets/js/62.ebee8eb0.js"><link rel="prefetch" href="/assets/js/63.43dcf02a.js"><link rel="prefetch" href="/assets/js/64.2486bd1a.js"><link rel="prefetch" href="/assets/js/65.cbd66da2.js"><link rel="prefetch" href="/assets/js/66.d56945f7.js"><link rel="prefetch" href="/assets/js/67.1f8c6266.js"><link rel="prefetch" href="/assets/js/68.2ab0aa52.js"><link rel="prefetch" href="/assets/js/69.585fe024.js"><link rel="prefetch" href="/assets/js/7.f63d3c78.js"><link rel="prefetch" href="/assets/js/70.3649fc8f.js"><link rel="prefetch" href="/assets/js/71.43fa98e5.js"><link rel="prefetch" href="/assets/js/72.e9946b7a.js"><link rel="prefetch" href="/assets/js/73.2a240a36.js"><link rel="prefetch" href="/assets/js/74.4d76c747.js"><link rel="prefetch" href="/assets/js/75.88b6c711.js"><link rel="prefetch" href="/assets/js/76.67ebeaf8.js"><link rel="prefetch" href="/assets/js/77.0209bc8a.js"><link rel="prefetch" href="/assets/js/78.3c703d69.js"><link rel="prefetch" href="/assets/js/79.3ac9abb6.js"><link rel="prefetch" href="/assets/js/8.ea6a0ff5.js"><link rel="prefetch" href="/assets/js/80.ba46f48b.js"><link rel="prefetch" href="/assets/js/81.df464987.js"><link rel="prefetch" href="/assets/js/82.e9d4ea8f.js"><link rel="prefetch" href="/assets/js/83.148ea71b.js"><link rel="prefetch" href="/assets/js/84.31a7fddc.js"><link rel="prefetch" href="/assets/js/85.15d74025.js"><link rel="prefetch" href="/assets/js/86.dbcfc16c.js"><link rel="prefetch" href="/assets/js/87.c1fa3487.js"><link rel="prefetch" href="/assets/js/88.3d23b3e9.js"><link rel="prefetch" href="/assets/js/89.2ff26d9f.js"><link rel="prefetch" href="/assets/js/9.ddaf5d78.js"><link rel="prefetch" href="/assets/js/90.c4461d39.js"><link rel="prefetch" href="/assets/js/91.4241f65f.js"><link rel="prefetch" href="/assets/js/92.691d187c.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.8b543e98.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.f8758a12.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d0e837cb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-b812d5fc data-v-92b43a16><header class="navbar" data-v-b812d5fc><div class="wrap"><div class="wrap-border"><a href="/" class="home-link router-link-active"><svg role="img" alt="Bitcoin Dev Kit Documentation" class="logo"><use href="/img/logo.svg#small" class="small"></use> <use href="/img/logo.svg#large" class="large"></use></svg></a> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/bitcoindevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/docs/" class="nav-link">
  Docs
</a></div><div class="nav-item"><a href="/adoption/all.html" class="nav-link">
  Adoption
</a></div><div class="nav-item"><a href="/foundation/" class="nav-link">
  Foundation
</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  Blog
</a></div> <a href="https://github.com/bitcoindevkit/bitcoindevkit.org" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <button type="button" class="theme-switch"><svg viewBox="0 0 30 31" fill="none" xmlns="http://www.w3.org/2000/svg"><g class="theme-switch-dark"><path d="M15 20.4219C12.5187 20.4219 10.5 18.4032 10.5 15.9219C10.5 13.4406 12.5187 11.4219 15 11.4219C17.4813 11.4219 19.5 13.4406 19.5 15.9219C19.5 18.4032 17.4813 20.4219 15 20.4219Z" fill="currentColor"></path> <path d="M19.4541 20.3769L21.3644 22.2862M15 24.9219V22.2219V24.9219ZM15 9.62187V6.92188V9.62187ZM6 15.9219H8.7H6ZM21.3 15.9219H24H21.3ZM8.6361 22.2862L10.5454 20.3769L8.6361 22.2862ZM19.4541 11.4678L21.3644 9.55797L19.4541 11.4678ZM8.6361 9.55797L10.5454 11.4678L8.6361 9.55797Z" stroke="currentColor" stroke-width="1" stroke-linecap="round"></path></g> <g fill="currentColor" class="theme-switch-light"><path d="M10.1539 8.75585C10.018 8.75585 9.88774 8.70189 9.79168 8.60583C9.69563 8.50977 9.64166 8.37949 9.64166 8.24365V6.19482C9.64166 6.05898 9.69563 5.9287 9.79168 5.83264C9.88774 5.73658 10.018 5.68262 10.1539 5.68262C10.2897 5.68262 10.42 5.73658 10.5161 5.83264C10.6121 5.9287 10.6661 6.05898 10.6661 6.19482V8.24365C10.6661 8.37949 10.6121 8.50977 10.5161 8.60583C10.42 8.70189 10.2897 8.75585 10.1539 8.75585Z"></path> <path d="M11.1783 7.73144H9.12945C8.9936 7.73144 8.86332 7.67748 8.76726 7.58142C8.6712 7.48536 8.61724 7.35508 8.61724 7.21924C8.61724 7.08339 8.6712 6.95311 8.76726 6.85705C8.86332 6.761 8.9936 6.70703 9.12945 6.70703H11.1783C11.3141 6.70703 11.4444 6.761 11.5405 6.85705C11.6365 6.95311 11.6905 7.08339 11.6905 7.21924C11.6905 7.35508 11.6365 7.48536 11.5405 7.58142C11.4444 7.67748 11.3141 7.73144 11.1783 7.73144ZM6.05621 13.8779C5.92037 13.8779 5.79009 13.8239 5.69403 13.7279C5.59797 13.6318 5.54401 13.5015 5.54401 13.3657V12.3413C5.54401 12.2054 5.59797 12.0752 5.69403 11.9791C5.79009 11.8831 5.92037 11.8291 6.05621 11.8291C6.19206 11.8291 6.32234 11.8831 6.4184 11.9791C6.51445 12.0752 6.56842 12.2054 6.56842 12.3413V13.3657C6.56842 13.5015 6.51445 13.6318 6.4184 13.7279C6.32234 13.8239 6.19206 13.8779 6.05621 13.8779Z"></path> <path d="M6.56842 13.366H5.544C5.40816 13.366 5.27788 13.312 5.18182 13.216C5.08576 13.1199 5.0318 12.9896 5.0318 12.8538C5.0318 12.7179 5.08576 12.5877 5.18182 12.4916C5.27788 12.3955 5.40816 12.3416 5.544 12.3416H6.56842C6.70426 12.3416 6.83454 12.3955 6.9306 12.4916C7.02666 12.5877 7.08062 12.7179 7.08062 12.8538C7.08062 12.9896 7.02666 13.1199 6.9306 13.216C6.83454 13.312 6.70426 13.366 6.56842 13.366ZM16.8125 23.6101C12.8583 23.6101 9.64165 20.3934 9.64165 16.4392C9.64165 12.8983 12.2851 9.85021 15.7907 9.34876L16.4658 9.25195L16.37 9.92755C16.326 10.218 16.3027 10.5112 16.3003 10.805C16.3003 14.1942 19.0575 16.9514 22.4468 16.9514C22.708 16.9514 22.9872 16.9294 23.3247 16.8813L23.9998 16.7855L23.9035 17.4606C23.401 20.9666 20.3524 23.6101 16.8125 23.6101Z"></path></g></svg></button></div> <div class="sidebar-button"><svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="icon"><g fill="currentColor" class="hamburger"><path d="M33.75 11.6699H6.25C5.55964 11.6699 5 12.2296 5 12.9199C5 13.6103 5.55964 14.1699 6.25 14.1699H33.75C34.4404 14.1699 35 13.6103 35 12.9199C35 12.2296 34.4404 11.6699 33.75 11.6699Z"></path> <path d="M28.75 18.752H6.25C5.55964 18.752 5 19.3116 5 20.002C5 20.6923 5.55964 21.252 6.25 21.252H28.75C29.4404 21.252 30 20.6923 30 20.002C30 19.3116 29.4404 18.752 28.75 18.752Z"></path> <path d="M33.75 25.8301H6.25C5.55964 25.8301 5 26.3897 5 27.0801C5 27.7704 5.55964 28.3301 6.25 28.3301H33.75C34.4404 28.3301 35 27.7704 35 27.0801C35 26.3897 34.4404 25.8301 33.75 25.8301Z"></path></g> <g stroke="currentColor" class="close"><path d="M10 10L30 30" stroke-width="2" stroke-linecap="round"></path> <path d="M30 10L10 30" stroke-width="2" stroke-linecap="round"></path></g></svg></div></div></div></header> <div class="wrap" data-v-b812d5fc><div class="wrap-border" data-v-b812d5fc><div class="sidebar-mask" data-v-b812d5fc></div> <aside class="sidebar" data-v-b812d5fc><nav class="nav-links"><div class="nav-item"><a href="https://github.com/bitcoindevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/docs/" class="nav-link">
  Docs
</a></div><div class="nav-item"><a href="/adoption/all.html" class="nav-link">
  Adoption
</a></div><div class="nav-item"><a href="/foundation/" class="nav-link">
  Foundation
</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  Blog
</a></div> <a href="https://github.com/bitcoindevkit/bitcoindevkit.org" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Blog</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/" aria-current="page" class="sidebar-link">Articles</a></li><li><a href="/blog/tags/" class="sidebar-link">Tags</a></li><li><a href="/blog/author/" class="sidebar-link">Authors</a></li></ul></section></li></ul> </aside> <main class="page" data-v-92b43a16><header class="theme-default-content post-header" data-v-92b43a16><h1 data-v-92b43a16>bdk_core: a new architecture for the Bitcoin Dev Kit</h1> <p class="meta" data-v-0f148fb8 data-v-92b43a16>
  By

  <span data-v-0f148fb8><a href="/blog/author/Lloyd Fournier" class="meta-link" data-v-0f148fb8>Lloyd Fournier</a><!----></span>

  on

  5/10/2022

  - Tags:

  <span data-v-0f148fb8><a href="/blog/tags/architecture" class="meta-link" data-v-0f148fb8>Architecture</a><!----></span></p> <hr data-v-92b43a16></header> <div class="theme-default-content content__default"><p>The Bitcoin Devkit (BDK) lets you do a lot of useful things through convenient high level
abstractions. It works great when these abstractions map nicely onto what you are trying to do. My
goal is to develop a new <code>bdk_core</code> library for when they don't. I want <code>bdk_core</code> to expose all the
useful <em>mechanisms</em> that BDK has inside it without them being tied to any particular usage <em>policy</em>
and with very minimal dependencies.</p> <p>The <code>bdk_core</code> idea is still &quot;in the lab&quot;. We're not sure yet whether <code>bdk_core</code> will just be what's
left of <code>bdk</code> once we spin off all the components that have extra dependencies into their own crates
and refine it a bit. In that case <code>bdk_core</code> will just be called <code>bdk v1.0.0</code> or something. Or it might
be that <code>bdk</code> lives on with its current APIs and uses stuff <code>bdk_core</code> to implement it internally.</p> <h2 id="the-separation-of-policy-and-mechanism"><a href="#the-separation-of-policy-and-mechanism" class="header-anchor">#</a> The separation of policy and mechanism</h2> <p>My guiding principle for <code>bdk_core</code> is the <em>separation of policy and mechanism</em>. This is
what I mean by these terms:</p> <ul><li><em>mechanism</em>: How you do a particular thing. Mechanism code is functional and doesn't change much.</li> <li><em>policy</em>: What you want to do. Policy code composes mechanisms to achieve something in
an application.</li></ul> <p>Here's a nice passage about why the designers of the <a href="https://en.wikipedia.org/wiki/X_Window_System" target="_blank" rel="noopener noreferrer">X window system<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> applied this principle. X has
been around since 1984 and doesn't look like it's going anywhere so it probably has a lot to teach us.
From <em><a href="https://en.wikipedia.org/wiki/The_Art_of_Unix_Programming" target="_blank" rel="noopener noreferrer">The Art of UNIX Programming<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></em>:</p> <blockquote><p>...we observed that the designers of X made a basic decision to implement “mechanism, not policy”—to
make X a generic graphics engine and leave decisions about user-interface style to toolkits and
other levels of the system. We justified this by pointing out that policy and mechanism tend to
mutate on different timescales, with policy changing much faster than mechanism. Fashions in the
look and feel of GUI toolkits may come and go, but raster operations and compositing are forever.</p></blockquote> <blockquote><p>Thus, hardwiring policy and mechanism together has two bad effects: It makes policy rigid and
harder to change in response to user requirements, and it means that trying to change policy has a
strong tendency to destabilize the mechanisms.</p></blockquote> <blockquote><p>On the other hand, by separating the two we make it
possible to experiment with new policy without breaking mechanisms. We also make it much easier to
write good tests for the mechanism (policy, because it ages so quickly, often does not justify the
investment).</p></blockquote> <ul><li>[ ] &gt; This design rule has wide application outside the GUI context. In general, it implies that we</li></ul> <blockquote><p>should look for ways to separate interfaces from engines.</p></blockquote> <p>You'll notice we have a similar situation in Bitcoin engineering. We have mechanism code like
signing algorithms, key derivation, transaction construction logic, etc., that don't change much. But
how these compose together in applications changes quickly over time and between applications.</p> <p>The main culprit of policy and mechanism conflation in <code>bdk</code> is the main <a href="https://docs.rs/bdk/latest/bdk/wallet/struct.Wallet.html" target="_blank" rel="noopener noreferrer"><code>Wallet</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> type.
Wallets do all of the following:</p> <ol><li>Store one or two descriptors (external and optional internal).</li> <li>Keep track of which addresses you've given out so you only give out fresh ones from each descriptor.</li> <li>Keep a list of transactions associated with the addresses in the wallet.</li> <li>Given a source of blockchain data it can update its internal list of transactions.</li> <li>Given some parameters it can build a PSBT from transaction outputs.</li> <li>Given a PSBT it can sign it with its <a href="https://docs.rs/bdk/latest/bdk/wallet/signer/index.html" target="_blank" rel="noopener noreferrer"><code>Signers</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ol> <p>All of that is very useful but it is bound together with the particular policies and opinions of <code>Wallet</code>.
If <code>Wallet</code>'s policy is not your policy it's going to be tricky to get it to do what you want.
Here are some examples:</p> <ol><li>In order to control how the <code>Wallet</code> will select coins for a transaction internally you have to
pass in something implementing the <a href="https://docs.rs/bdk/latest/bdk/wallet/coin_selection/trait.CoinSelectionAlgorithm.html" target="_blank" rel="noopener noreferrer"><code>CoinSelectionAlgorithm</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> trait. A coin selection algorithm
is clearly mechanism code but the policy of <code>Wallet</code> restricts that mechanism's interface. We
have <a href="https://github.com/bitcoindevkit/bdk/issues/281" target="_blank" rel="noopener noreferrer">very old issues<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> related to what the
interface of this trait should be and we don't have a clear way forward. In <code>bdk_core</code> I want to
purely provide the coin selection mechanisms for figuring out whether you need to select more
UTXOs or whether you need a change output etc. How you use that mechanism will be up to you.</li> <li>Another trait that has a similar structure is the <a href="https://docs.rs/bdk/latest/bdk/wallet/signer/index.html" target="_blank" rel="noopener noreferrer"><code>Signer</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> trait. You have to pass in signers
so your wallet can sign PSBTs but you have little control over how the wallet chooses which
signers to use in any given situation. Right now the wallet will just iterate through all the
signers and ask them to sign. This is not always appropriate. In <code>bdk_core</code> I want to provide
functions for populating PSBTs given something that can sign. You'll be in control of when they
get called.</li></ol> <h2 id="a-syncing-mechansim-without-the-policy"><a href="#a-syncing-mechansim-without-the-policy" class="header-anchor">#</a> A syncing mechansim without the policy</h2> <p>Syncing in <code>bdk</code> is the place where the design of <code>Wallet</code> is most restrictive. The <a href="https://docs.rs/bdk/latest/bdk/blockchain/trait.WalletSync.html" target="_blank" rel="noopener noreferrer"><code>WalletSync</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
trait forces you to sync all addresses in a wallet in one big batch. But this is not always what you
want to do. I spoke to a developer who wanted to sync his wallet slowly over time with each address
being queried over a different Tor connection. It would be really difficult to implement
<code>WalletSync</code> with such a strategy. Another example where <code>WalletSync</code> isn't the right fit is the
<a href="https://l2.technology/sensei" target="_blank" rel="noopener noreferrer">Sensei<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> project which uses BDK but incrementally updates the database whenever new information
comes in from the blockchain.</p> <p>Even if syncing all addresses at the same time is roughly what you want to do <code>WalletSync</code> still
gets in the way since it defines whether you do it synchronously or asynchrononusly. Applications
can control this through <code>bdk</code>'s <code>async-interface</code> feature flag which internally changes the trait
definition through macros. Another annoyance is that when using <code>async-interface</code> the future that
gets returned from <code>WalletSync</code> <a href="https://github.com/bitcoindevkit/bdk/issues/165" target="_blank" rel="noopener noreferrer">cannot be <code>Send</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
because of how <code>Wallet</code> handles database mutability internally, meaning you can't spawn the future
into a new thread.</p> <h3 id="a-general-syncing-mechanism"><a href="#a-general-syncing-mechanism" class="header-anchor">#</a> A general syncing mechanism</h3> <p>So what is the most general syncing mechanism that solves these problems? These are the things I
think it has to do regardless of where the blockchain data comes from or how it's stored:</p> <ol><li>Generate and store addresses.</li> <li>Index transaction data, e.g. transaction outputs we own, when/if they were spent, etc.</li> <li>Keep track of which addresses have been given out and which have been used.</li> <li>Be able to &quot;roll back&quot; our view of the above data if a reorg makes some of it stale.</li> <li>Keep track of transactions related our addresses in our mempool.</li></ol> <p>Let's talk about how to implement a mechanism that does all that.</p> <h3 id="how-to-store-and-index-transactions"><a href="#how-to-store-and-index-transactions" class="header-anchor">#</a> How to store and index transactions</h3> <p>Different persistent storage backends have different APIs and their own indexing strategies. That's
why the <a href="https://docs.rs/bdk/latest/bdk/database/trait.Database.html" target="_blank" rel="noopener noreferrer"><code>Database</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> trait exists in BDK, to make a clean API to the different storage engines. It's
important to note that the database in BDK only holds public data that could always be retrieved
from the chain. It's just a cache. Despite this we support different backends. Right now it is a
lot of work to add a new index to the data since you have to add it to every backend and you might have
to apply schema changes (we still <a href="https://github.com/bitcoindevkit/bdk/issues/359" target="_blank" rel="noopener noreferrer">don't have a standard approach to
this<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>).</p> <p>Thomas Eizinger <a href="https://github.com/bitcoindevkit/bdk/issues/165#issuecomment-1047483895" target="_blank" rel="noopener noreferrer">suggested<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
doing everything in memory and only writing to persistent storage when it was convenient. It took me
some time but I came around to this idea. It would allow us to get rid of the <code>Database</code> trait (at
least at the <code>bdk_core</code> level) and greatly simplify what the persistent storage layer has to do.
Whenever the data is loaded from persistent storage we can just do the indexing in memory and
present it to the application.</p> <p><em>But wait! Wouldn't this mean we'd use way more memory than we need to?</em> Yes but memory is cheap.
Consider that if we say the average transaction size is 300 bytes then with all our indexes each
transaction might cost 1kb of memory (pessimistically). This means we could index one thousand
transactions in a single megabyte! My iPhone has 4gb of memory so it could index a million
transactions with plenty of memory to spare. <em>But what if some users can't afford an iPhone?</em> Then
they also couldn't have afforded to have made a million Bitcoin transactions! <em>But what about memory
constrained devices like hardware wallets!?</em> Those devices typically don't store and retrieve
transactions. They're usually just signing devices. Perhaps one day someone will build a memory
constrained device that needs to do this work but until then I think this is a fine approach to
take.</p> <p>For now I'm calling this thing that does the in-memory indexing of transactions related to a single
descriptor a <code>DescriptorTracker</code>. Here's a diagram that communicates how I imagine it relates to the
other components.</p> <figure><img src="/assets/img/descriptor-tracker.5942c853.jpg" alt=""></figure> <h3 id="rolling-back-rolling-forward-and-syncing-to-disk"><a href="#rolling-back-rolling-forward-and-syncing-to-disk" class="header-anchor">#</a> Rolling back, rolling forward and syncing to disk</h3> <p>State changes in blockchains are clearly delineated. They all happen in blocks! Every view of the
blockchain, whether you're getting it through compact block filters, an electrum server or something
wacky like a utreexo bridge will have a concept of blocks and transactions in them. For a wallet we
only need a very sparse view of the blockchain that includes at which block a set of transactions
existed. That way, if a block disappears we know that all those transactions might disappear too.</p> <p>With <code>bdk_core</code> I want to introduce the concept of a <em>checkpoint</em>, which is a block height and hash and
a set of txids that were present at that height <strong>but not present in the previous checkpoint</strong>. In
this way we create an append-only data structure that can easily be rolled back to a previous height
if there is a reorg. After rolling back we can then roll forward and apply the new blocks.</p> <p>Here's an example of how this idea works:</p> <figure><img src="/assets/img/checkpoints.a4179787.jpg" alt=""></figure> <p>There are a few edge cases I'd like to cover:</p> <ol><li>What if when gathering new data from the chain to update a <code>DescriptorTracker</code> we find an old transaction that belongs to an earlier checkpoint that we had missed form our earlier syncs?</li> <li>What if when we go to write to persistent storage from a <code>DescriptorTracker</code> we find that it has some transactions the tracker doesn't? Should we try and reconcile the two sets of transactions?</li></ol> <p>I think the correct approach is to treat the chain data as the source of truth for the
<code>DescriptorTracker</code> and the <code>DescriptorTracker</code> as the source of truth for persistent storage. That
is in the case of (1) we should just rollback the <code>DescriptorTracker</code> and insert the old but
recently discovered transaction in the right place. In the case of (2) we should roll back the
persistent storage to the point where it differs and apply changes from there. This implies that you
should only keep one instance of a <code>DescriptorTracker</code> for a descriptor in your application and only
update persistent storage by first applying the changes to the tracker.</p> <h2 id="examples"><a href="#examples" class="header-anchor">#</a> Examples</h2> <p>Here are some examples of what I think this may end up looking like in code. Keep in mind that if
this looks complicated it will probably be more complicated in practice! This doesn't mean that we
can't create simplifying abstractions and tools around these primitives to cover common policies. I hope we can implement <code>Wallet</code> with <code>DescriptorTracker</code>s internally.</p> <h3 id="doing-an-initial-sync-of-a-descriptor-that-may-already-contain-coins"><a href="#doing-an-initial-sync-of-a-descriptor-that-may-already-contain-coins" class="header-anchor">#</a> Doing an initial sync of a descriptor that may already contain coins</h3> <p>When we first sync a descriptor that may already contain coins we want to iterate over all the
scripts of the wallet and then stop if there's a big enough gap (e.g. 20). In this example we use an
stateless <a href="https://mempool.space/docs/api/rest" target="_blank" rel="noopener noreferrer">esplora-like API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// create a descriptor tracker the external addresses of a BIP86 key</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> tracker <span class="token operator">=</span> <span class="token class-name">DescriptorTracker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;tr([73c5da0a/86'/0'/0']xpub6BgBgsespWvERF3LHQu6CnqdvfEvtMcQjYrcRzx53QJjSxarj2afYWcLteoGVky7D3UKDP9QyrLprQ3VCECoY49yfdDEHGCtMMj92pReUsQ/0/*)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> esplora <span class="token operator">=</span> <span class="token namespace">bdk_esplora<span class="token punctuation">::</span></span><span class="token class-name">Client</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> update <span class="token operator">=</span> esplora<span class="token punctuation">.</span><span class="token function">fetch_related_transactions</span><span class="token punctuation">(</span><span class="token namespace">bdk_esplora<span class="token punctuation">::</span></span><span class="token class-name">Params</span> <span class="token punctuation">{</span>
   <span class="token comment">// iterate over all addresses in a descriptor</span>
   scripts<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>tracker<span class="token punctuation">.</span><span class="token function">iter_scripts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token comment">// stop if you find a gap of 20 unused addresses</span>
   stop_gap<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>

tracker<span class="token punctuation">.</span><span class="token function">apply_update</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

<span class="token comment">// now we want to persist this disk</span>
<span class="token keyword">let</span> db_update <span class="token operator">=</span> tracker<span class="token punctuation">.</span><span class="token function">generate_update</span><span class="token punctuation">(</span><span class="token class-name">Params</span> <span class="token punctuation">{</span>
    start_checkpoint<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Note that the db_update type is the same as the `update` above.</span>
my_db<span class="token punctuation">.</span><span class="token function">apply_update</span><span class="token punctuation">(</span>db_update<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="doing-a-sync-of-a-wallet-after-you-already-have-syncd"><a href="#doing-a-sync-of-a-wallet-after-you-already-have-syncd" class="header-anchor">#</a> Doing a sync of a wallet after you already have sync'd</h3> <p>Now imagine you just want to check if any UTXOs in your wallet have been spent. In this case we've
already sync'd before so we need to load that data into the tracker from disk first (rather than
going straight to the blockchain). Then we just ask esplora for transactions related to these
transaction outputs.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// create a descriptor tracker the external addresses of a BIP86 key</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> tracker <span class="token operator">=</span> <span class="token class-name">DescriptorTracker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;tr([73c5da0a/86'/0'/0']xpub6BgBgsespWvERF3LHQu6CnqdvfEvtMcQjYrcRzx53QJjSxarj2afYWcLteoGVky7D3UKDP9QyrLprQ3VCECoY49yfdDEHGCtMMj92pReUsQ/0/*)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> init_update <span class="token operator">=</span> my_db<span class="token punctuation">.</span><span class="token function">generate_update</span><span class="token punctuation">(</span><span class="token class-name">Params</span> <span class="token punctuation">{</span>
    checkpoint<span class="token punctuation">:</span> <span class="token class-name">None</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// get up to speed with what was on disk.</span>
tracker<span class="token punctuation">.</span><span class="token function">apply_update</span><span class="token punctuation">(</span>init_update<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// get the latest checkpoint</span>
<span class="token keyword">let</span> checkpoint <span class="token operator">=</span> tracker<span class="token punctuation">.</span><span class="token function">get_checkpoint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> esplora <span class="token operator">=</span> <span class="token namespace">bdk_esplora<span class="token punctuation">::</span></span><span class="token class-name">Client</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Fetch transactions spending any utxos we have</span>
<span class="token keyword">let</span> update <span class="token operator">=</span> esplora<span class="token punctuation">.</span><span class="token function">fetch_related_transactions</span><span class="token punctuation">(</span> <span class="token namespace">bdk_esplora<span class="token punctuation">::</span></span><span class="token class-name">Params</span> <span class="token punctuation">{</span>
   checkpoint<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>checkpoint<span class="token punctuation">)</span><span class="token punctuation">,</span>
   tx_outs<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>tracker<span class="token punctuation">.</span><span class="token function">iter_unspent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>

<span class="token keyword">match</span> update <span class="token punctuation">{</span>
   <span class="token class-name">Ok</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       tracker<span class="token punctuation">.</span><span class="token function">apply_update</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
       <span class="token comment">// now we want to persist this disk</span>
       <span class="token keyword">let</span> db_update <span class="token operator">=</span> tracker<span class="token punctuation">.</span><span class="token function">generate_update</span><span class="token punctuation">(</span><span class="token class-name">Params</span> <span class="token punctuation">{</span>
           <span class="token comment">// this call could fail if tracker no longer has this checkpoint.</span>
           <span class="token comment">// In this case we'd ask persistent_storage for an earlier checkpoint and try again.</span>
           start_checkpoint<span class="token punctuation">:</span> persistent_storage<span class="token punctuation">.</span><span class="token function">get_checkpoint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       persistent_storage<span class="token punctuation">.</span><span class="token function">apply_update</span><span class="token punctuation">(</span>db_update<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token namespace">bdk_esplora<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token punctuation">::</span><span class="token class-name">StaleCheckpoint</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// here we should call fetch related transactions with an earlier checkpoint.</span>
      <span class="token comment">// In practice this logic will be called in a loop</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="updating-state-when-you-get-the-data-in-real-time"><a href="#updating-state-when-you-get-the-data-in-real-time" class="header-anchor">#</a> Updating state when you get the data in real time</h3> <p>If you have an event based view of the blockchain that feeds you block connected or block
disconnected events then I imagine the API would look something like this.
There's quite a bit left out here but I hope you get the idea.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// create a descriptor tracker the external addresses of a BIP86 key</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> tracker <span class="token operator">=</span> <span class="token class-name">DescriptorTracker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;tr([73c5da0a/86'/0'/0']xpub6BgBgsespWvERF3LHQu6CnqdvfEvtMcQjYrcRzx53QJjSxarj2afYWcLteoGVky7D3UKDP9QyrLprQ3VCECoY49yfdDEHGCtMMj92pReUsQ/0/*)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">let</span> blockchain_events <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* get a Stream of blockchain block connected/disconnected events */</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">loop</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> blockchain_event <span class="token operator">=</span>  blockchain_events<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> blockchain_event <span class="token punctuation">{</span>
        <span class="token class-name">BlockChainEvent</span><span class="token punctuation">::</span><span class="token class-name">Connected</span><span class="token punctuation">(</span>new_block<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">match</span> tracker<span class="token punctuation">.</span><span class="token function">apply_block</span><span class="token punctuation">(</span>new_block<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span>modified<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">if</span> modified <span class="token punctuation">{</span>
                    <span class="token comment">// update persistent storage from tracker</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ApplyBlockError</span><span class="token punctuation">::</span><span class="token class-name">OutOfOrder</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// the block event we got was not the next block we expected.</span>
                    <span class="token comment">// How to recover from this will depend on the application and block source</span>
                <span class="token punctuation">}</span>
           <span class="token punctuation">}</span><span class="token punctuation">,</span>
           <span class="token class-name">BlockchainEvent</span><span class="token punctuation">::</span><span class="token class-name">Disconnected</span><span class="token punctuation">(</span><span class="token punctuation">(</span>disconnected_height<span class="token punctuation">,</span> disconnected_hash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token comment">// this might invalidate a checkpoint</span>
              tracker<span class="token punctuation">.</span><span class="token function">disconnect_block</span><span class="token punctuation">(</span>disconnected_height<span class="token punctuation">,</span> disconnected_hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// Now apply to persistent storage</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="feedback"><a href="#feedback" class="header-anchor">#</a> Feedback</h2> <p>The best way to give feedback on this would be to comment on the <a href="https://github.com/bitcoindevkit/bitcoindevkit.org/pull/100" target="_blank" rel="noopener noreferrer">pull request<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for this blog post.
Thanks in advance.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/bitcoindevkit/bitcoindevkit.org/edit/master/docs/_blog/bdk_core_pt1.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/31/2025, 4:21:40 PM</span></div></footer> <!----> </main></div></div> <footer class="footer" data-v-b812d5fc><div class="wrap"><div class="wrap-border"><div class="inner"><div class="footer-content"><div class="footer-block"><h4>Docs</h4> <div><a href="/docs/#book" class="nav-link">
  Book
</a></div><div><a href="/docs/#rust-apis" class="nav-link">
  Rust APIs
</a></div><div><a href="/docs/#other-apis" class="nav-link">
  Other APIs
</a></div></div><div class="footer-block"><h4>Community</h4> <div><a href="https://github.com/bitcoindevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div><a href="nostr:npub13dk3dke4zm9vdkucm7f6vv7vhqgkevgg3gju9kr2wzumz7nrykdq0dgnvc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nostr
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div><a href="https://twitter.com/intent/follow?screen_name=bitcoindevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Twitter
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div><a href="https://discord.gg/dstn4dQ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Chat on Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></div><div class="footer-block"><h4>More</h4> <div><a href="/blog/" class="nav-link router-link-active">
  Blog
</a></div><div><a href="/foundation/supporters/" class="nav-link">
  Supporters
</a></div><div><a href="/foundation/" class="nav-link">
  BDK Foundation
</a></div></div></div> <p class="copyright">Copyright © 2025 BDK Developers</p></div></div></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2ad4e539.js" defer></script><script src="/assets/js/4.421e1146.js" defer></script><script src="/assets/js/1.519cc26e.js" defer></script><script src="/assets/js/34.40447606.js" defer></script>
  </body>
</html>
