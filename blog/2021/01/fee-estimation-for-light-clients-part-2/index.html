<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Fee estimation for light-clients (Part 2) | Bitcoin Dev Kit Documentation</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="preload" href="/fonts/ibm-plex-mono-400.woff2" as="font" crossorigin="true">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="/css/variables.css">
    <link name="msapplication-config" content="/browserconfig.xml">
    <link name="msapplication-TileColor" content="#ffffff">
    <link name="theme-color" content="#ffffff">
    <meta name="description" content="Applying machine learning to the bitcoin fee estimation problem">
    <meta property="article:published_time" content="2021-01-25T00:00:00.000Z">
    <meta property="og:site_name" content="Bitcoin Dev Kit Documentation">
    <meta property="og:title" content="Fee estimation for light-clients (Part 2)">
    <meta property="og:description" content="Applying machine learning to the bitcoin fee estimation problem">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://bitcoindevkit.org/blog/2021/01/fee-estimation-for-light-clients-part-2/">
    <meta property="og:image" content="https://bitcoindevkit.org/card.png">
    <meta name="twitter:title" content="Fee estimation for light-clients (Part 2)">
    <meta name="twitter:description" content="Applying machine learning to the bitcoin fee estimation problem">
    <meta name="twitter:url" content="https://bitcoindevkit.org/blog/2021/01/fee-estimation-for-light-clients-part-2/">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="https://bitcoindevkit.org/card.png">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="fee, machine learning">
    <meta property="article:tag" content="fee">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    
    <link rel="preload" href="/assets/css/0.styles.5522b66b.css" as="style"><link rel="preload" href="/assets/js/app.49cb010f.js" as="script"><link rel="preload" href="/assets/js/8.55b54433.js" as="script"><link rel="preload" href="/assets/js/1.f3a41fb6.js" as="script"><link rel="preload" href="/assets/js/20.393f04cb.js" as="script"><link rel="prefetch" href="/assets/js/10.83ad8561.js"><link rel="prefetch" href="/assets/js/11.97ca935c.js"><link rel="prefetch" href="/assets/js/12.699fc59f.js"><link rel="prefetch" href="/assets/js/13.95de545c.js"><link rel="prefetch" href="/assets/js/14.010007aa.js"><link rel="prefetch" href="/assets/js/15.3a079bc5.js"><link rel="prefetch" href="/assets/js/16.07453d8d.js"><link rel="prefetch" href="/assets/js/17.cc15050e.js"><link rel="prefetch" href="/assets/js/18.f0fd99f2.js"><link rel="prefetch" href="/assets/js/19.f0050e50.js"><link rel="prefetch" href="/assets/js/21.7ba850b0.js"><link rel="prefetch" href="/assets/js/22.cc1bb4f2.js"><link rel="prefetch" href="/assets/js/23.e7ec4fdc.js"><link rel="prefetch" href="/assets/js/24.0893932e.js"><link rel="prefetch" href="/assets/js/25.f78ec8ea.js"><link rel="prefetch" href="/assets/js/26.b56bce49.js"><link rel="prefetch" href="/assets/js/27.5a286f2b.js"><link rel="prefetch" href="/assets/js/28.bd8177d4.js"><link rel="prefetch" href="/assets/js/29.400b72a9.js"><link rel="prefetch" href="/assets/js/30.acf6ce02.js"><link rel="prefetch" href="/assets/js/31.a42051ef.js"><link rel="prefetch" href="/assets/js/32.e0d53f0b.js"><link rel="prefetch" href="/assets/js/33.cccb4442.js"><link rel="prefetch" href="/assets/js/34.2f08ffc4.js"><link rel="prefetch" href="/assets/js/35.9f18295c.js"><link rel="prefetch" href="/assets/js/36.d11cb8e1.js"><link rel="prefetch" href="/assets/js/37.fb5cba2e.js"><link rel="prefetch" href="/assets/js/38.b13c6798.js"><link rel="prefetch" href="/assets/js/39.c4c5e5b1.js"><link rel="prefetch" href="/assets/js/40.5c080bca.js"><link rel="prefetch" href="/assets/js/41.24855987.js"><link rel="prefetch" href="/assets/js/42.0a9dc77c.js"><link rel="prefetch" href="/assets/js/43.724175af.js"><link rel="prefetch" href="/assets/js/44.d9b0f3f1.js"><link rel="prefetch" href="/assets/js/45.9601bde0.js"><link rel="prefetch" href="/assets/js/46.77c3a8a9.js"><link rel="prefetch" href="/assets/js/47.16bef72b.js"><link rel="prefetch" href="/assets/js/48.d081fa75.js"><link rel="prefetch" href="/assets/js/49.cc60def6.js"><link rel="prefetch" href="/assets/js/5.1d2e4e53.js"><link rel="prefetch" href="/assets/js/50.8d60e8a2.js"><link rel="prefetch" href="/assets/js/51.e1c72f3a.js"><link rel="prefetch" href="/assets/js/52.fe877448.js"><link rel="prefetch" href="/assets/js/53.6f8ea983.js"><link rel="prefetch" href="/assets/js/6.e3e5b041.js"><link rel="prefetch" href="/assets/js/7.887f4a00.js"><link rel="prefetch" href="/assets/js/9.903b1e70.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.0e3e6337.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.e7f568dc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5522b66b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-9ca807bc data-v-5a6fa056><header class="navbar" data-v-9ca807bc><div class="wrap"><div class="wrap-border"><a href="/" class="home-link router-link-active"><svg role="img" alt="Bitcoin Dev Kit Documentation" class="logo"><use href="/img/logo.svg#small" class="small"></use> <use href="/img/logo.svg#large" class="large"></use></svg></a> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/getting-started/" class="nav-link">
  Docs
</a></div><div class="nav-item"><a href="/tutorials/hello-world.html" class="nav-link">
  Tutorials
</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  Blog
</a></div><div class="nav-item"><a href="https://discord.gg/dstn4dQ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/bitcoindevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/bitcoindevkit/bitcoindevkit.org" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <button type="button" class="theme-switch"><svg viewBox="0 0 30 31" fill="none" xmlns="http://www.w3.org/2000/svg"><g class="theme-switch-dark"><path d="M15 20.4219C12.5187 20.4219 10.5 18.4032 10.5 15.9219C10.5 13.4406 12.5187 11.4219 15 11.4219C17.4813 11.4219 19.5 13.4406 19.5 15.9219C19.5 18.4032 17.4813 20.4219 15 20.4219Z" fill="currentColor"></path> <path d="M19.4541 20.3769L21.3644 22.2862M15 24.9219V22.2219V24.9219ZM15 9.62187V6.92188V9.62187ZM6 15.9219H8.7H6ZM21.3 15.9219H24H21.3ZM8.6361 22.2862L10.5454 20.3769L8.6361 22.2862ZM19.4541 11.4678L21.3644 9.55797L19.4541 11.4678ZM8.6361 9.55797L10.5454 11.4678L8.6361 9.55797Z" stroke="currentColor" stroke-width="1" stroke-linecap="round"></path></g> <g fill="currentColor" class="theme-switch-light"><path d="M10.1539 8.75585C10.018 8.75585 9.88774 8.70189 9.79168 8.60583C9.69563 8.50977 9.64166 8.37949 9.64166 8.24365V6.19482C9.64166 6.05898 9.69563 5.9287 9.79168 5.83264C9.88774 5.73658 10.018 5.68262 10.1539 5.68262C10.2897 5.68262 10.42 5.73658 10.5161 5.83264C10.6121 5.9287 10.6661 6.05898 10.6661 6.19482V8.24365C10.6661 8.37949 10.6121 8.50977 10.5161 8.60583C10.42 8.70189 10.2897 8.75585 10.1539 8.75585Z"></path> <path d="M11.1783 7.73144H9.12945C8.9936 7.73144 8.86332 7.67748 8.76726 7.58142C8.6712 7.48536 8.61724 7.35508 8.61724 7.21924C8.61724 7.08339 8.6712 6.95311 8.76726 6.85705C8.86332 6.761 8.9936 6.70703 9.12945 6.70703H11.1783C11.3141 6.70703 11.4444 6.761 11.5405 6.85705C11.6365 6.95311 11.6905 7.08339 11.6905 7.21924C11.6905 7.35508 11.6365 7.48536 11.5405 7.58142C11.4444 7.67748 11.3141 7.73144 11.1783 7.73144ZM6.05621 13.8779C5.92037 13.8779 5.79009 13.8239 5.69403 13.7279C5.59797 13.6318 5.54401 13.5015 5.54401 13.3657V12.3413C5.54401 12.2054 5.59797 12.0752 5.69403 11.9791C5.79009 11.8831 5.92037 11.8291 6.05621 11.8291C6.19206 11.8291 6.32234 11.8831 6.4184 11.9791C6.51445 12.0752 6.56842 12.2054 6.56842 12.3413V13.3657C6.56842 13.5015 6.51445 13.6318 6.4184 13.7279C6.32234 13.8239 6.19206 13.8779 6.05621 13.8779Z"></path> <path d="M6.56842 13.366H5.544C5.40816 13.366 5.27788 13.312 5.18182 13.216C5.08576 13.1199 5.0318 12.9896 5.0318 12.8538C5.0318 12.7179 5.08576 12.5877 5.18182 12.4916C5.27788 12.3955 5.40816 12.3416 5.544 12.3416H6.56842C6.70426 12.3416 6.83454 12.3955 6.9306 12.4916C7.02666 12.5877 7.08062 12.7179 7.08062 12.8538C7.08062 12.9896 7.02666 13.1199 6.9306 13.216C6.83454 13.312 6.70426 13.366 6.56842 13.366ZM16.8125 23.6101C12.8583 23.6101 9.64165 20.3934 9.64165 16.4392C9.64165 12.8983 12.2851 9.85021 15.7907 9.34876L16.4658 9.25195L16.37 9.92755C16.326 10.218 16.3027 10.5112 16.3003 10.805C16.3003 14.1942 19.0575 16.9514 22.4468 16.9514C22.708 16.9514 22.9872 16.9294 23.3247 16.8813L23.9998 16.7855L23.9035 17.4606C23.401 20.9666 20.3524 23.6101 16.8125 23.6101Z"></path></g></svg></button></div> <div class="sidebar-button"><svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="icon"><g fill="currentColor" class="hamburger"><path d="M33.75 11.6699H6.25C5.55964 11.6699 5 12.2296 5 12.9199C5 13.6103 5.55964 14.1699 6.25 14.1699H33.75C34.4404 14.1699 35 13.6103 35 12.9199C35 12.2296 34.4404 11.6699 33.75 11.6699Z"></path> <path d="M28.75 18.752H6.25C5.55964 18.752 5 19.3116 5 20.002C5 20.6923 5.55964 21.252 6.25 21.252H28.75C29.4404 21.252 30 20.6923 30 20.002C30 19.3116 29.4404 18.752 28.75 18.752Z"></path> <path d="M33.75 25.8301H6.25C5.55964 25.8301 5 26.3897 5 27.0801C5 27.7704 5.55964 28.3301 6.25 28.3301H33.75C34.4404 28.3301 35 27.7704 35 27.0801C35 26.3897 34.4404 25.8301 33.75 25.8301Z"></path></g> <g stroke="currentColor" class="close"><path d="M10 10L30 30" stroke-width="2" stroke-linecap="round"></path> <path d="M30 10L10 30" stroke-width="2" stroke-linecap="round"></path></g></svg></div></div></div></header> <div class="wrap" data-v-9ca807bc><div class="wrap-border" data-v-9ca807bc><div class="sidebar-mask" data-v-9ca807bc></div> <aside class="sidebar" data-v-9ca807bc><nav class="nav-links"><div class="nav-item"><a href="/getting-started/" class="nav-link">
  Docs
</a></div><div class="nav-item"><a href="/tutorials/hello-world.html" class="nav-link">
  Tutorials
</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  Blog
</a></div><div class="nav-item"><a href="https://discord.gg/dstn4dQ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/bitcoindevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/bitcoindevkit/bitcoindevkit.org" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Blog</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/" aria-current="page" class="sidebar-link">Articles</a></li><li><a href="/blog/tags/" class="sidebar-link">Tags</a></li><li><a href="/blog/author/" class="sidebar-link">Authors</a></li></ul></section></li></ul> </aside> <main class="page" data-v-5a6fa056><header class="theme-default-content post-header" data-v-5a6fa056><h1 data-v-5a6fa056>Fee estimation for light-clients (Part 2)</h1> <p class="meta" data-v-070abed8 data-v-5a6fa056>
  By

  <span data-v-070abed8><a href="/blog/author/Riccardo Casatta" class="meta-link" data-v-070abed8>Riccardo Casatta</a><!----></span>

  on

  1/26/2021

  - Tags:

  <span data-v-070abed8><a href="/blog/tags/fee" class="meta-link" data-v-070abed8>Fee</a>, </span><span data-v-070abed8><a href="/blog/tags/machine learning" class="meta-link" data-v-070abed8>Machine learning</a><!----></span></p> <hr data-v-5a6fa056></header> <div class="theme-default-content content__default"><p>This post is part 2 of 3 of a series. (<a href="/blog/2021/01/fee-estimation-for-light-clients-part-1/">Part 1</a>, <a href="/blog/2021/01/fee-estimation-for-light-clients-part-3/">Part 3</a>)</p> <ul><li><a href="#the-dataset">The dataset</a> <ul><li><a href="#the-mempool">The mempool</a></li> <li><a href="#the-outliers">The outliers</a></li> <li><a href="#recap">Recap</a></li></ul></li></ul> <h2 id="the-dataset"><a href="#the-dataset" class="header-anchor">#</a> The dataset</h2> <p>The <a href="https://storage.googleapis.com/bitcoin_log/dataset_18.csv.gz" target="_blank" rel="noopener noreferrer">dataset<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is publicly available (~500MB gzip compressed, ~2GB as plain CSV).</p> <p>The output of the model is the fee rate, expressed in <code>[satoshi/vbytes]</code>.</p> <p>What about the inputs? Generally speaking, we have two main requirements for what can be included as input for our model:</p> <ul><li>It must be correlated to the output, even with a non-linear relation.</li> <li>It must be available to a light client: for instance, assuming to have knowledge and an index of the last 1000 blocks is considered too much.</li></ul> <p>To evaluate the approach we are taking, we also want to compare our model's results with another available estimation: for this reason the dataset includes data to compute the error agains Bitcoin Core's <code>estimatesmartfee</code> results, even though we are not going to use it for this model.</p> <p>The dataset will contain only transactions that spend already confirmed inputs. If we wanted to include transactions with unconfirmed inputs as well, the fee rate would have to be computed as a whole;
for example if transaction <code>t2</code> spends an unconfirmed input from <code>t1</code> (while <code>t1</code> only spends confirmed inputs, and all its other outputs are unspent), the aggregated fee rate would have to be used.
Supposing <code>f()</code> is extracts the absolute fee and <code>w()</code> the transaction weight, the aggregated fee rate would be <code>(f(t1) + f(t2)) / (w(t1) + w(t2))</code>. Thus, as already said previously, to keep things simple the model simply discards all the transaction
that would need to perform this computation.</p> <p>For the same reason the dataset has the <code>parent_in_cpfp</code> flag. When a transaction has inputs confirmed (so it's not excluded by the previous rule) but one or more of its output have been spent by a transaction confirmed in the same block, <code>parent_in_cpfp</code> is <code>1</code>.
Transactions with <code>parent_in_cpfp = 1</code> are included in the dataset but excluded by the current model, since the miner probably considered an aggregated fee rate while picking the transactions to build a block.</p> <h4 id="the-mempool"><a href="#the-mempool" class="header-anchor">#</a> The mempool</h4> <p>The most important input of our model is the current <em>status</em> of the mempool itself. However, we cannot feed the model with a list of the fee rate of every unconfirmed transaction, because this array would have a variable length.
To overcome this, the transaction contained in the mempool are grouped in &quot;buckets&quot; which are basically subsets of the mempool where all the transactions contained in a bucket have a similar fee rate. In particular we only care about the
<em>number</em> of transaction in every <em>bucket</em>, not which transactions it contains.</p> <p>The mempool buckets array is defined by two parameters, the <code>percentage_increment</code> and the <code>array_max</code> value.
Starting from the minimum fee rate value <code>min_relay_fee=1.0</code>, the <code>ith</code> element is: <code>a_i=min_relay_fee * (1+percentage_increment)^(i+1)</code></p> <p>For instance, choosing the mempool buckets array to have parameters <code>percentage_increment = 50%</code> and <code>array_max = 500.0 sat/vbytes</code> the buckets would be constructed like so:</p> <table><thead><tr><th>bucket</th> <th>bucket min fee rate</th> <th>bucket max fee rate</th></tr></thead> <tbody><tr><td>a_0</td> <td>1.0</td> <td>1.5</td></tr> <tr><td>a_1</td> <td>1.5</td> <td>2.25</td></tr> <tr><td>a_2</td> <td>2.25</td> <td>3.375</td></tr> <tr><td>a_15</td> <td>437.89</td> <td>inf</td></tr></tbody></table> <p>The array stops at <code>a15</code> because <code>a16</code> would have a bucket min greater than <code>array_max</code>.</p> <p>The model is for light-client such as <a href="https://github.com/bitcoin/bips/blob/master/bip-0157.mediawiki" target="_blank" rel="noopener noreferrer">neutrino<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> based ones. In these clients the mempool is already available (it's needed to check for received transactions) but we can't compute fee rates of this transactions because previous confirmed inputs are not in the mempool!</p> <p>Luckily, <strong>thanks to temporal locality <sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>, an important part of mempool transactions spend outputs created very recently</strong>, for example in the last 6 blocks.
The blocks are available through the p2p network, and downloading the last 6 is considered a good compromise between resource consumption and accurate prediction. We need the model to be built with the same data available in the prediction phase, as a consequence <em>the mempool data in the dataset refers only to transactions having their inputs in the last 6 blocks</em>. However the <code>bitcoin-csv</code> tool inside the <a href="https://github.com/RCasatta/bitcoin_logger" target="_blank" rel="noopener noreferrer">data logger<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> allows to configure this parameter.</p> <h4 id="the-outliers"><a href="#the-outliers" class="header-anchor">#</a> The outliers</h4> <p>The dataset also contains the block percentile fee rate <code>q_k</code>, considering <code>r_i</code> to be the rate of the <code>ith</code> transaction in a block, <code>q_k</code> is the fee rate value such that for each transaction in a block <code>r_i</code> &lt; <code>q_k</code> returns the <code>k%</code> transactions in the block that are paying lower fees.</p> <p>Percentiles are not used to feed the model but to filter some outliers tx.
Removing this observations is controversial at best and considered cheating at worse. However, it should be considered that Bitcoin Core <code>estimatesmartfee</code> doesn't even bother to give estimation for the next block, we think this is due to the fact that many transactions that are confirming in the next block are huge overestimation, or clearly errors like <a href="https://blockstream.info/tx/33291156ab79e9b4a1019b618b0acfa18cbdf8fa6b71c43a9eed62a849b86f9a" target="_blank" rel="noopener noreferrer">this one<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> we found when we started logging data.
These outliers are several for transactions confirming in the next block (<code>confirms_in=1</code>), less so for <code>confirms_in=2</code>, mostly disappeared for <code>confirms_in=3</code> or more. It's counterintuitive that overestimation exists for <code>confirms_in&gt;1</code>, by definition an overestimation is a fee rate way higher than needed, so how is possible that an overestimation doesn't enter the very next block? There are a couple of reasons why a block is discovered without containing a transaction with high fee rate:</p> <ul><li>network latency: my node saw the transaction but the miner didn't see that transaction yet,</li> <li>block building latency: the miner saw the transaction, but didn't finish to rebuild the block template or decided it's more efficient to finish a cycle on the older block template.</li></ul> <p>To keep the model balanced, when overestimation is filtered out, underestimation are filtered out as well. This also has the effect to remove some of the transactions possibly included because a fee is payed out-of-band.
Another reason to filter transactions is that the dataset is over-represented by transactions with low <code>confirms_in</code>: more than 50% of transactions get confirmed in the next block, so we think it's good to filter some of these transactions.</p> <p>The applied filters are the following:</p> <table><thead><tr><th>confirms_in</th> <th>lower</th> <th>higher</th></tr></thead> <tbody><tr><td>1</td> <td>q45</td> <td>q55</td></tr> <tr><td>2</td> <td>q30</td> <td>q70</td></tr> <tr><td>3</td> <td>q1</td> <td>q99</td></tr></tbody></table> <p>Not yet convinced by the removal of these outliers? The <a href="https://storage.googleapis.com/bitcoin_log/dataset_18.csv.gz" target="_blank" rel="noopener noreferrer">dataset<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> contains all the observations, make your model ðŸ˜ƒ</p> <h4 id="recap"><a href="#recap" class="header-anchor">#</a> Recap</h4> <table><thead><tr><th>column</th> <th>used in the model</th> <th>description</th></tr></thead> <tbody><tr><td>txid</td> <td>no</td> <td>Transaction hash, useful for debugging</td></tr> <tr><td>timestamp</td> <td>converted</td> <td>The time when the transaction has been added in the mempool, in the model is used in the form <code>day_of_week</code> and <code>hour</code></td></tr> <tr><td>current_height</td> <td>no</td> <td>The blockchain height seen by the node in this moment</td></tr> <tr><td>confirms_in</td> <td>yes</td> <td>This transaction confirmed at block height <code>current_height+confirms_in</code></td></tr> <tr><td>fee_rate</td> <td>target</td> <td>This transaction fee rate measured in <code>[sat/vbytes]</code></td></tr> <tr><td>fee_rate_bytes</td> <td>no</td> <td>fee rate in satoshi / bytes, used to check Bitcoin Core <code>estimatesmartfee</code> predictions</td></tr> <tr><td>block_avg_fee</td> <td>no</td> <td>block average fee rate <code>[sat/vbytes]</code> of block <code>current_height+confirms_in</code></td></tr> <tr><td>core_econ</td> <td>no</td> <td>bitcoin <code>estimatesmartfee</code> result for <code>confirms_in</code> block target and in economic mode. Could be not available <code>?</code> when a block is connected more recently than the estimation has been requested, estimation are requested every 10 secs.</td></tr> <tr><td>core_cons</td> <td>no</td> <td>Same as above but with conservative mode</td></tr> <tr><td>mempool_len</td> <td>no</td> <td>Sum of the mempool transactions with fee rate available (sum of every <code>a*</code> field)</td></tr> <tr><td>parent_in_cpfp</td> <td>no</td> <td>It's 1 when the transaction has outputs that are spent in the same block in which the transaction is confirmed (they are parent in a CPFP relations).</td></tr> <tr><td>q1-q30-...</td> <td>no</td> <td>Transaction confirming fast could be outliers, usually paying a lot more than required, this percentiles are used to filter those transactions,</td></tr> <tr><td>a1-a2-...</td> <td>yes</td> <td>Contains the number of transaction in the mempool with known fee rate in the ith bucket.</td></tr></tbody></table> <p><img src="/img/fee-estimation-for-light-clients/the-good-the-bad-the-ugly.jpg" alt="The good, the bad and the ugly"></p><div align="center">My biological neural network fired this, I think it's because a lot of chapters start with &quot;The&quot;</div> <br><br><p></p> <p>In the previous <a href="/blog/2021/01/fee-estimation-for-light-clients-part-1/">Part 1</a> we talked about the problem.</p> <p>In the following <a href="/blog/2021/01/fee-estimation-for-light-clients-part-3/">Part 3</a> we are going to talk about the model.</p> <hr class="footnotes-sep"> <section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>In computer science temporal locality refers to the tendency to access recent data more often than older data. <a href="#fnref1" class="footnote-backref">â†©ï¸Ž</a></p></li></ol></section></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/bitcoindevkit/bitcoindevkit.org/edit/master/docs/_blog/fee_estimation_for_light_clients_part_2.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/5/2022, 2:26:26 PM</span></div></footer> <!----> </main></div></div> <footer class="footer" data-v-9ca807bc><div class="wrap"><div class="wrap-border"><div class="inner"><div class="footer-content"><div class="footer-block"><h4>Docs</h4> <div><a href="/getting-started/" class="nav-link">
  Getting Started
</a></div><div><a href="/bdk-cli/installation/" class="nav-link">
  BDK-CLI
</a></div><div><a href="/descriptors/" class="nav-link">
  Descriptors
</a></div></div><div class="footer-block"><h4>Community</h4> <div><a href="https://github.com/bitcoindevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div><a href="https://twitter.com/intent/follow?screen_name=bitcoindevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Twitter
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div><a href="https://discord.gg/dstn4dQ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Chat on Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></div><div class="footer-block"><h4>More</h4> <div><a href="/blog/" class="nav-link router-link-active">
  Blog
</a></div><div><a href="/supporters/" class="nav-link">
  Supporters
</a></div></div></div> <p class="copyright">Copyright Â© 2022 BDK Developers</p></div></div></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.49cb010f.js" defer></script><script src="/assets/js/8.55b54433.js" defer></script><script src="/assets/js/1.f3a41fb6.js" defer></script><script src="/assets/js/20.393f04cb.js" defer></script>
  </body>
</html>
