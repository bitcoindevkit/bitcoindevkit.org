<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Wizardsardine BDK Audit Report | Bitcoin Dev Kit Documentation</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="preload" href="/fonts/ibm-plex-mono-400.woff2" as="font" crossorigin="true">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="/css/variables.css">
    <link name="msapplication-config" content="/browserconfig.xml">
    <link name="msapplication-TileColor" content="#ffffff">
    <link name="theme-color" content="#ffffff">
    <meta name="description" content="2024 Code Audit by Wizardsardine">
    <meta property="article:published_time" content="2024-10-21T00:00:00.000Z">
    <meta property="og:site_name" content="Bitcoin Dev Kit Documentation">
    <meta property="og:title" content="Wizardsardine BDK Audit Report">
    <meta property="og:description" content="2024 Code Audit by Wizardsardine">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://bitcoindevkit.org/audits/2024_q4/bdk_audit_report/">
    <meta property="og:image" content="https://bitcoindevkit.org/card.png">
    <meta name="twitter:title" content="Wizardsardine BDK Audit Report">
    <meta name="twitter:description" content="2024 Code Audit by Wizardsardine">
    <meta name="twitter:url" content="https://bitcoindevkit.org/audits/2024_q4/bdk_audit_report/">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="https://bitcoindevkit.org/card.png">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="BDK, project">
    <meta property="article:tag" content="BDK">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    
    <link rel="preload" href="/assets/css/0.styles.512b91ab.css" as="style"><link rel="preload" href="/assets/js/app.3bab8f60.js" as="script"><link rel="preload" href="/assets/js/3.80705bfd.js" as="script"><link rel="preload" href="/assets/js/1.5c570f52.js" as="script"><link rel="preload" href="/assets/js/88.37800373.js" as="script"><link rel="prefetch" href="/assets/js/10.f21ee655.js"><link rel="prefetch" href="/assets/js/11.a68d1fca.js"><link rel="prefetch" href="/assets/js/12.4ddd9d16.js"><link rel="prefetch" href="/assets/js/13.0c1a5d6a.js"><link rel="prefetch" href="/assets/js/17.24c35731.js"><link rel="prefetch" href="/assets/js/18.1812466a.js"><link rel="prefetch" href="/assets/js/19.0a54e72b.js"><link rel="prefetch" href="/assets/js/2.fd388b48.js"><link rel="prefetch" href="/assets/js/20.4afabc31.js"><link rel="prefetch" href="/assets/js/21.b0bf609d.js"><link rel="prefetch" href="/assets/js/22.ce2ebeba.js"><link rel="prefetch" href="/assets/js/23.cb3e8ba5.js"><link rel="prefetch" href="/assets/js/24.c16d5c47.js"><link rel="prefetch" href="/assets/js/25.14c0156e.js"><link rel="prefetch" href="/assets/js/26.ead2ae9d.js"><link rel="prefetch" href="/assets/js/27.74a4b5e4.js"><link rel="prefetch" href="/assets/js/28.4585b6a3.js"><link rel="prefetch" href="/assets/js/29.f190b725.js"><link rel="prefetch" href="/assets/js/30.0f8d4edd.js"><link rel="prefetch" href="/assets/js/31.48e3e671.js"><link rel="prefetch" href="/assets/js/32.db3d85c3.js"><link rel="prefetch" href="/assets/js/33.7c798f47.js"><link rel="prefetch" href="/assets/js/34.16dd5e6f.js"><link rel="prefetch" href="/assets/js/35.582dba25.js"><link rel="prefetch" href="/assets/js/36.dc4493eb.js"><link rel="prefetch" href="/assets/js/37.3a3cfdd7.js"><link rel="prefetch" href="/assets/js/38.6082069e.js"><link rel="prefetch" href="/assets/js/39.21e65f5d.js"><link rel="prefetch" href="/assets/js/4.28545876.js"><link rel="prefetch" href="/assets/js/40.c32a6c06.js"><link rel="prefetch" href="/assets/js/41.b51a7c0a.js"><link rel="prefetch" href="/assets/js/42.0f0b0d49.js"><link rel="prefetch" href="/assets/js/43.8f5f16f6.js"><link rel="prefetch" href="/assets/js/44.08c4ef25.js"><link rel="prefetch" href="/assets/js/45.f3653e4c.js"><link rel="prefetch" href="/assets/js/46.01cab1bc.js"><link rel="prefetch" href="/assets/js/47.8edc3801.js"><link rel="prefetch" href="/assets/js/48.aa3449a4.js"><link rel="prefetch" href="/assets/js/49.de6c70d1.js"><link rel="prefetch" href="/assets/js/5.c00dde2b.js"><link rel="prefetch" href="/assets/js/50.36c05f80.js"><link rel="prefetch" href="/assets/js/51.15c6cca3.js"><link rel="prefetch" href="/assets/js/52.2b7ab145.js"><link rel="prefetch" href="/assets/js/53.d9627ff2.js"><link rel="prefetch" href="/assets/js/54.a557c1a1.js"><link rel="prefetch" href="/assets/js/55.5f20a230.js"><link rel="prefetch" href="/assets/js/56.21c43e25.js"><link rel="prefetch" href="/assets/js/57.f07cf7c2.js"><link rel="prefetch" href="/assets/js/58.486a29a1.js"><link rel="prefetch" href="/assets/js/59.490782f8.js"><link rel="prefetch" href="/assets/js/6.d24b2ecc.js"><link rel="prefetch" href="/assets/js/60.27a907f1.js"><link rel="prefetch" href="/assets/js/61.6f771608.js"><link rel="prefetch" href="/assets/js/62.70c87fbc.js"><link rel="prefetch" href="/assets/js/63.db826881.js"><link rel="prefetch" href="/assets/js/64.f2b2cafc.js"><link rel="prefetch" href="/assets/js/65.b63b408e.js"><link rel="prefetch" href="/assets/js/66.e798a913.js"><link rel="prefetch" href="/assets/js/67.2f9c8ab6.js"><link rel="prefetch" href="/assets/js/68.3ced40cf.js"><link rel="prefetch" href="/assets/js/69.b9f70bfb.js"><link rel="prefetch" href="/assets/js/7.ad7bf61d.js"><link rel="prefetch" href="/assets/js/70.d0efe690.js"><link rel="prefetch" href="/assets/js/71.c03ccb59.js"><link rel="prefetch" href="/assets/js/72.e7a7fa83.js"><link rel="prefetch" href="/assets/js/73.7e7b03b6.js"><link rel="prefetch" href="/assets/js/74.7a44e8b1.js"><link rel="prefetch" href="/assets/js/75.6183a840.js"><link rel="prefetch" href="/assets/js/76.1479b4b3.js"><link rel="prefetch" href="/assets/js/77.4765fb18.js"><link rel="prefetch" href="/assets/js/78.7f4e25f8.js"><link rel="prefetch" href="/assets/js/79.fb9dfbe3.js"><link rel="prefetch" href="/assets/js/8.90b8eff0.js"><link rel="prefetch" href="/assets/js/80.b9092154.js"><link rel="prefetch" href="/assets/js/81.02290dc5.js"><link rel="prefetch" href="/assets/js/82.011b8006.js"><link rel="prefetch" href="/assets/js/83.05a2567e.js"><link rel="prefetch" href="/assets/js/84.ded4cd66.js"><link rel="prefetch" href="/assets/js/85.2ad6bda4.js"><link rel="prefetch" href="/assets/js/86.c9502bf5.js"><link rel="prefetch" href="/assets/js/87.04b239fe.js"><link rel="prefetch" href="/assets/js/89.c2929c29.js"><link rel="prefetch" href="/assets/js/9.adf4d38f.js"><link rel="prefetch" href="/assets/js/90.f8f7edee.js"><link rel="prefetch" href="/assets/js/91.86e62bb3.js"><link rel="prefetch" href="/assets/js/92.31252843.js"><link rel="prefetch" href="/assets/js/93.81a8a6af.js"><link rel="prefetch" href="/assets/js/94.8c2b421c.js"><link rel="prefetch" href="/assets/js/95.71e0e660.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.b6c99b38.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.e9610d83.js">
    <link rel="stylesheet" href="/assets/css/0.styles.512b91ab.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-b812d5fc><header class="navbar" data-v-b812d5fc><div class="wrap"><div class="wrap-border"><a href="/" class="home-link router-link-active"><svg role="img" alt="Bitcoin Dev Kit Documentation" class="logo"><use href="/img/logo.svg#small" class="small"></use> <use href="/img/logo.svg#large" class="large"></use></svg></a> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/bitcoindevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/docs/" class="nav-link">
  Docs
</a></div><div class="nav-item"><a href="/adoption/all.html" class="nav-link">
  Adoption
</a></div><div class="nav-item"><a href="/foundation/about.html" class="nav-link">
  Foundation
</a></div><div class="nav-item"><a href="/blog/" class="nav-link">
  Blog
</a></div> <a href="https://github.com/bitcoindevkit/bitcoindevkit.org" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <button type="button" class="theme-switch"><svg viewBox="0 0 30 31" fill="none" xmlns="http://www.w3.org/2000/svg"><g class="theme-switch-dark"><path d="M15 20.4219C12.5187 20.4219 10.5 18.4032 10.5 15.9219C10.5 13.4406 12.5187 11.4219 15 11.4219C17.4813 11.4219 19.5 13.4406 19.5 15.9219C19.5 18.4032 17.4813 20.4219 15 20.4219Z" fill="currentColor"></path> <path d="M19.4541 20.3769L21.3644 22.2862M15 24.9219V22.2219V24.9219ZM15 9.62187V6.92188V9.62187ZM6 15.9219H8.7H6ZM21.3 15.9219H24H21.3ZM8.6361 22.2862L10.5454 20.3769L8.6361 22.2862ZM19.4541 11.4678L21.3644 9.55797L19.4541 11.4678ZM8.6361 9.55797L10.5454 11.4678L8.6361 9.55797Z" stroke="currentColor" stroke-width="1" stroke-linecap="round"></path></g> <g fill="currentColor" class="theme-switch-light"><path d="M10.1539 8.75585C10.018 8.75585 9.88774 8.70189 9.79168 8.60583C9.69563 8.50977 9.64166 8.37949 9.64166 8.24365V6.19482C9.64166 6.05898 9.69563 5.9287 9.79168 5.83264C9.88774 5.73658 10.018 5.68262 10.1539 5.68262C10.2897 5.68262 10.42 5.73658 10.5161 5.83264C10.6121 5.9287 10.6661 6.05898 10.6661 6.19482V8.24365C10.6661 8.37949 10.6121 8.50977 10.5161 8.60583C10.42 8.70189 10.2897 8.75585 10.1539 8.75585Z"></path> <path d="M11.1783 7.73144H9.12945C8.9936 7.73144 8.86332 7.67748 8.76726 7.58142C8.6712 7.48536 8.61724 7.35508 8.61724 7.21924C8.61724 7.08339 8.6712 6.95311 8.76726 6.85705C8.86332 6.761 8.9936 6.70703 9.12945 6.70703H11.1783C11.3141 6.70703 11.4444 6.761 11.5405 6.85705C11.6365 6.95311 11.6905 7.08339 11.6905 7.21924C11.6905 7.35508 11.6365 7.48536 11.5405 7.58142C11.4444 7.67748 11.3141 7.73144 11.1783 7.73144ZM6.05621 13.8779C5.92037 13.8779 5.79009 13.8239 5.69403 13.7279C5.59797 13.6318 5.54401 13.5015 5.54401 13.3657V12.3413C5.54401 12.2054 5.59797 12.0752 5.69403 11.9791C5.79009 11.8831 5.92037 11.8291 6.05621 11.8291C6.19206 11.8291 6.32234 11.8831 6.4184 11.9791C6.51445 12.0752 6.56842 12.2054 6.56842 12.3413V13.3657C6.56842 13.5015 6.51445 13.6318 6.4184 13.7279C6.32234 13.8239 6.19206 13.8779 6.05621 13.8779Z"></path> <path d="M6.56842 13.366H5.544C5.40816 13.366 5.27788 13.312 5.18182 13.216C5.08576 13.1199 5.0318 12.9896 5.0318 12.8538C5.0318 12.7179 5.08576 12.5877 5.18182 12.4916C5.27788 12.3955 5.40816 12.3416 5.544 12.3416H6.56842C6.70426 12.3416 6.83454 12.3955 6.9306 12.4916C7.02666 12.5877 7.08062 12.7179 7.08062 12.8538C7.08062 12.9896 7.02666 13.1199 6.9306 13.216C6.83454 13.312 6.70426 13.366 6.56842 13.366ZM16.8125 23.6101C12.8583 23.6101 9.64165 20.3934 9.64165 16.4392C9.64165 12.8983 12.2851 9.85021 15.7907 9.34876L16.4658 9.25195L16.37 9.92755C16.326 10.218 16.3027 10.5112 16.3003 10.805C16.3003 14.1942 19.0575 16.9514 22.4468 16.9514C22.708 16.9514 22.9872 16.9294 23.3247 16.8813L23.9998 16.7855L23.9035 17.4606C23.401 20.9666 20.3524 23.6101 16.8125 23.6101Z"></path></g></svg></button></div> <div class="sidebar-button"><svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="icon"><g fill="currentColor" class="hamburger"><path d="M33.75 11.6699H6.25C5.55964 11.6699 5 12.2296 5 12.9199C5 13.6103 5.55964 14.1699 6.25 14.1699H33.75C34.4404 14.1699 35 13.6103 35 12.9199C35 12.2296 34.4404 11.6699 33.75 11.6699Z"></path> <path d="M28.75 18.752H6.25C5.55964 18.752 5 19.3116 5 20.002C5 20.6923 5.55964 21.252 6.25 21.252H28.75C29.4404 21.252 30 20.6923 30 20.002C30 19.3116 29.4404 18.752 28.75 18.752Z"></path> <path d="M33.75 25.8301H6.25C5.55964 25.8301 5 26.3897 5 27.0801C5 27.7704 5.55964 28.3301 6.25 28.3301H33.75C34.4404 28.3301 35 27.7704 35 27.0801C35 26.3897 34.4404 25.8301 33.75 25.8301Z"></path></g> <g stroke="currentColor" class="close"><path d="M10 10L30 30" stroke-width="2" stroke-linecap="round"></path> <path d="M30 10L10 30" stroke-width="2" stroke-linecap="round"></path></g></svg></div></div></div></header> <div class="wrap" data-v-b812d5fc><div class="wrap-border" data-v-b812d5fc><div class="sidebar-mask" data-v-b812d5fc></div> <aside class="sidebar" data-v-b812d5fc><nav class="nav-links"><div class="nav-item"><a href="https://github.com/bitcoindevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/docs/" class="nav-link">
  Docs
</a></div><div class="nav-item"><a href="/adoption/all.html" class="nav-link">
  Adoption
</a></div><div class="nav-item"><a href="/foundation/about.html" class="nav-link">
  Foundation
</a></div><div class="nav-item"><a href="/blog/" class="nav-link">
  Blog
</a></div> <a href="https://github.com/bitcoindevkit/bitcoindevkit.org" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <!----> <main class="page"> <div class="theme-default-content content__default"><p><a href="https://spiral.xyz/" target="_blank" rel="noopener noreferrer">Spiral<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> hired <a href="https://wizardsardine.com/" target="_blank" rel="noopener noreferrer">Wizardsardine<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for 10 days to perform
a (partial) audit of the <a href="https://github.com/bitcoindevkit/bdk" target="_blank" rel="noopener noreferrer">BDK wallet library<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (at tag
<code>v1.0.0-beta.2</code>).</p> <p>This audit was focused on the <code>bdk_chain</code>, <code>bdk_electrum</code>/<code>bdk_esplora</code> and <code>bdk_wallet</code> crates with
the intention to look for defects which could lead to returning incorrect information to a user
about their wallet or to prevent them from reliably using it under realistic circumstances (e.g. a
crash bug which can be triggered by a third party, or a significant slowdown in performing some
operations).</p> <p>A threat model I considered interesting for the purpose of this review was that of a server-side
software using BDK to perform Bitcoin tasks and serving its clients through a public API. In this
fairly standard scenario, a crash internal to the BDK library could lead to a Denial of Service for
all users of the application.</p> <p>From my discussion with the developers of the library, remote Esplora and Electrum servers are
trusted sources of information about the Bitcoin network. A rogue server providing invalid
information is therefore considered out of scope. Likewise, I didn't focus on finding crashes that
can be triggered by a malicious server (although I did report some).</p> <p>I have used test coverage reports to guide me throughout this audit. I join to this document a full
report of the code coverage of all the unit tests from the library. It's available
<a href="https://darosior.github.io/bdk_coverage/unit_tests/coverage/home/darosior/projects/bdk/crates/index.html" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <figure><img src="bdk_audit_test_coverage.png" alt="image"></figure> <p>We conducted this audit in three parts. First I carefully inspected the code of each module under
review for logic errors, leveraging the unit test framework. I did not find it necessary to write
and share new unit tests (besides some reproductions, see the details section) since the reviewed
module already have extensive unit test coverage as can be observed from the above report. A second
part of the audit was undertaken by @Pythcoiner (who works with us at Wizardsardine on Liana's QA)
and consisted of manually testing the library, looking for surprising behaviour in corner cases.
Finally, I wrote two fuzz targets (code is shared along with this report):</p> <ul><li>The first one exercised the <code>Wallet</code> interface under a number of conditions with data generated by
the fuzzer (apply an update, roundtrip to persistence, or create a transaction, then repeat). It's
more superfluous as it's general, but is a good way to assert some general invariants (for
instance &quot;the balance is the same before and after round-tripping to persistence&quot;) and checking
nothing crashes if we just throw random data at the high-level interface.</li> <li>The second one specifically targets the reorg logic in <code>bdk_chain</code> (the <code>merge_chains</code> function).
Based on the fuzzer's input it creates an initial chain and an updated chain, merges the two, then
asserts some invariants (it does connect when it should, etc).</li></ul> <p>BDK is a large project and 10 days is not enough to perform a comprehensive review of the library.
Only the 4 modules I focused on already amount to 15,777 lines of code (without accounting for the
unit test directories). Here is a list of things I did not have time to do and think would be
beneficial:</p> <ul><li>More fuzz coverage. I only started writing a couple fuzz targets after having reviewed the 15k
lines of sources. These targets can be improved, asserting more invariants and exercising more
logic. New, more specific, targets may also be introduced. As BDK currently has no fuzz coverage,
and its modular architecture makes it adapted to fuzzing, this is probably the highest value thing
to implement to further give assurance in the quality of the library.</li> <li>Deeper review of the unit tests. I only skimmed through those, allocating my remaining time to
writing the fuzz targets instead. Despite the good coverage, reading carefully the unit tests is a
good way to stumble upon / think of edge cases which aren't (completely) tested.</li> <li>Review of the persistence (in particular the SQLite implementation) and the coin selection
modules. The findings reported in this area are due to my fuzzer, I did not carefully review the
logic there.</li> <li>Benchmark the transaction graph reconciliation with the canonical chain in the presence of large
unconfirmed transaction chains and/or high number of conflicts.</li></ul> <p>Overall, I found the code I reviewed to be of high quality and adequately tested. The library is
also elegantly architectured.</p> <h2 id="bdk-chain"><a href="#bdk-chain" class="header-anchor">#</a> bdk_chain</h2> <p>The &quot;anchors&quot; model elegantly avoids potential consistency issues when syncing: even if the chain
tip of the source changes while you're querying it, you always have the individual anchors from
which you can reconcile. The downside, of course, is that for every operation on the graph you have
to reconcile which transactions are &quot;canonical&quot; for a given chain.</p> <p>The cost of checking a transaction's confirmation status should stay manageable as long as the chain
source isn't sending maliciously crafted anchors (since it could effectively lead
<code>try_get_chain_position</code> to iterate across the whole chain for each transaction and every single of
its ancestors and descendants, which can quickly blowup for a transaction chain). However, the check
of whether an output is spent is <code>O(n^2)</code>. Typically under the threat model of BDK running on a
server and serving an API to multiple clients, a single client could DoS the server (thereby
preventing all other users from accessing information about their wallet) by creating a bunch of
RBF's for an output it owns. See below for details.</p> <p>The <code>seen_at</code> mechanism makes sense, but it being a timestamp is imperfect as two conflicting
transactions might share the same <code>last_seen</code> value. A timestamp is certainly a useful information
to store and provide to users, but for the purpose of ordering conflicting unconfirmed transactions
a counter may be preferable. Clients could choose to use <code>last_seen</code> as a counter, but some
functions in the library assume it is a timestamp (for instance <code>TxGraph::apply_update()</code> inserts
the current time as <code>seen_at</code> when applying the update).</p> <p>In the <code>keychain_txout</code> module documentation, you advise to only check revealed scriptpubkeys for
regular sync. This is fragile as it only guarantees not to miss deposits for single-person
descriptors where a single wallet is used. The documentation currently presents lookahead scripts as
specific to full scans when recovering a wallet. It'd be preferable to advise using a lookahead at
all times, even if only a smaller one for regular syncs.</p> <p>I haven't thought about a realistic scenario in which this could be an issue, but note two different
descriptor templates (as in actual descriptors are differing, not only the xpubs inside) can have
the same descriptor ID. For instance <code>multi(1,A,B)</code> and <code>sortedmulti(1,B,A)</code>.</p> <h3 id="security-risks"><a href="#security-risks" class="header-anchor">#</a> Security risks</h3> <ul><li>For a given outpoint <code>try_get_chain_spend</code> will iterate over all its (conflicting) spends and call
<code>try_get_chain_position</code> for each of those, which will in turn iterate over all its conflicts
(since the transaction itself is part of the <code>unconfirmed_ancestors_tx</code> iterator) until one is
confirmed or has a higher <code>seen_at</code>. As an example, let's take a confirmed outpoint spent by a
transaction RBF'd 100 times. For each version of the spending transaction <code>try_get_chain_spend</code>
will call <code>try_get_chain_position</code>, which will iterate over its ancestors using
<code>TxAncestors::new_include_root()</code>, which includes itself. In this example the iterator will only
contain the spend itself. Then <code>walk_conflicts</code> will be called on the spend, which will return an
iterator over all the 99 other spends of the original outpoint from which we'll only break after
encountering a transaction with a higher <code>seen_at</code>.  Since we'll do that for each of the 100
spends, assuming the <code>seen_at</code> values of the transaction are perfectly ordered, we'll perform
<code>99*100/2 = 4950</code> iterations (99 for the first one, 98 for the second one, and so on down to 1 for
the last one). This issue is further exacerbated by how:
<ol><li>each spend can spend more than one output. If each is spending a 100 outputs, that's 49'500
iterations in total.</li> <li>even after one of the conflicting spends gets mined this might still be an issue, depending on
the position of the confirmed spend in the <code>spends</code> map (which is indexed by outpoint, so can
be gamed).</li> <li>current RBF rules requiring a feerate increase can be bypassed:
https://github.com/bitcoin/bitcoin/pull/23121, which largely reduces the cost of an attack
exploiting this.</li></ol></li> <li>In <code>apply_changeset</code> the derivation index aren't sanitized. It could include a hardened index,
which would break an invariant and trigger an internal crash.</li></ul> <h3 id="quirks"><a href="#quirks" class="header-anchor">#</a> Quirks</h3> <ul><li>The return value of <code>self._check_changeset_is_applied(&amp;changeset)</code> in <code>LocalChain::apply_update</code>
isn't checked. I think you want it inside a <code>debug_assert!</code> like the other occurrences.</li> <li><code>list_canonical_txs</code> is missing the <code>Error = Infallible</code> type constraint.</li> <li>In <code>try_get_chain_position</code> the logic to filter out confirmed ancestors was copy-pasted for the
descendants (you can see as the comment wasn't updated, it still mentions &quot;We're filtering the
ancestors&quot;). But if a confirmed descendant is encountered it means the transaction is confirmed
too, so it could shortcut?</li></ul> <h3 id="nits"><a href="#nits" class="header-anchor">#</a> Nits</h3> <ul><li>No need to re-define <code>rust-bitcoin</code>'s <code>COINBASE_MATURITY</code>.</li> <li><code>CheckPoint</code>'s doc comment could mention it's guaranteed to always have at least one element,
since it's an invariant relied upon across the project.</li> <li><code>merge_chains</code>'s doc comment is outdated.</li> <li>The doc comment for the <code>rusqlite_impl</code> module is a placeholder: <code>//! Module for stuff</code>.</li> <li>Like <code>walk_ancestors</code>, <code>walk_descendants</code>'s doc could mention it excludes the root tx from the
iterator.</li> <li>In <code>SpkIterator::next()</code>, <code>derived_descriptor</code>'s descriptor is unwrapped because &quot;the descriptor
cannot need hardened derivation&quot;. It'd be better to have &quot;we check it's never hardened in the
constructor&quot; as it's a stronger invariant. (Mentioning as I initially missed it was also checked
in <code>SpkIterator::new_with_range()</code> by re-assigning to <code>end</code> the minimum between <code>end</code> and
<code>BIP32_MAX_INDEX</code>.)</li> <li>For <code>SpkTxOutIndex::outputs_in_range()</code> the excluded bounds aren't tested, you can just change
them to whatever and no test would fail.</li></ul> <h2 id="bdk-esplora"><a href="#bdk-esplora" class="header-anchor">#</a> <code>bdk_esplora</code></h2> <p>One thing I initially intended to look for was consistency issues in <code>sync</code> and <code>full_scan</code> if the
server's tip change while you are making requests (for instance getting duplicate transactions in
case a block is reorg'd). But this is not an issue in the BDK model which uses individual anchors
per transaction.</p> <p>It's surprising that <code>seen_ats</code> doesn't get populated in the sync result. The documentation could at
least mention the returned <code>TxUpdate</code> will always have an empty <code>seen_ats</code> mapping and populating
that is left as a responsibility of the caller.</p> <h3 id="security-risks-2"><a href="#security-risks-2" class="header-anchor">#</a> Security risks</h3> <ul><li>Out of scope, but a rogue Esplora server can make an application crash by returning an empty list
of blocks to a <code>/blocks</code> request, as <code>latest_blocks</code> is assumed to never be empty in
<code>fetch_block()</code>.</li></ul> <h3 id="nits-2"><a href="#nits-2" class="header-anchor">#</a> Nits</h3> <ul><li>Top-level documentation states &quot;A <code>stop_gap</code> of 0 will be treated as a <code>stop_gap</code> of 1&quot; but it's
not the case. After making <code>parallel_requests</code> requests in the first iteration of the loop, even
if all indexes were detected as active, <code>gap_limit_reached</code> would be set to <code>true</code> if <code>stop_gap</code>
is set to <code>0</code>. Not only would it not be the case if <code>stop_gap</code> was set to 1, but it's also
surprising to stop whereas there was no gap.</li></ul> <h2 id="bdk-electrum"><a href="#bdk-electrum" class="header-anchor">#</a> <code>bdk_electrum</code></h2> <p>The implementation assumes the remote server would not purposefully try to crash us nor serve us
invalid data. It should be possible to protect from malicious servers by syncing the best header
chain and validating Merkle proofs for confirmed transactions against it. Syncing the header chain
is itself prone to DoS if na√Øvely done through the P2P protocol (cf <a href="https://bitcoincore.org/en/2024/09/18/disclose-headers-oom/" target="_blank" rel="noopener noreferrer">this Bitcoin Core security
advisory<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>). The fix implemented in
Bitcoin Core introduces complexity which may not be required for a wallet library, where just using
recent checkpoints would be more reasonable than for a full node. Alternatively, BDK could leverage
the Electrum peer discovery protocol and assume at least one of N queried servers provides it the most
work chain. As Electrum permits to query the header chain backward from the tip it should also be
possible to verify it without resorting to something akin to Bitcoin Core's pre-sync.</p> <p>Checking Merkle proof of transactions against the most work chain would make it possible to protect
from a malicious server trivially crashing the wallet or providing invalid data for free. This still
leaves the door open to being crashed using unconfirmed transaction data, which may only be solved
by limiting the number of unconfirmed transactions stored in the graph. In any case the server is
trusted with the validity of unconfirmed transactions data.</p> <p>As advised I did not spend too much time looking for remote crash bugs from the part of the Electrum
server, as it can always do that right now by sending a ton of data to be stored. Though I did
mention those I came across.</p> <h3 id="security-risks-3"><a href="#security-risks-3" class="header-anchor">#</a> Security risks</h3> <ul><li>Transaction Merkle proof verification does not check the Merkle proof for the coinbase in addition
to get the depth of the Merkle tree. This enables an attack by which an attacker can fake a
deeply-confirmed payment to a BDK wallet for the cost of bruteforcing around 70 bits (maybe less).
See
https://delvingbitcoin.org/t/great-consensus-cleanup-revival/710#merkle-tree-attacks-using-64-bytes-transactions-8.
This would require the Electrum server to be malicious as well.</li> <li>An Electrum server can trigger a panic in <code>populate_with_txids</code> by returning a transaction with no
output to a <code>transaction.get</code> call.</li></ul> <h3 id="quirks-bugs"><a href="#quirks-bugs" class="header-anchor">#</a> Quirks / Bugs</h3> <ul><li><code>fetch_prev_txout</code> should not try to query the prevouts of coinbase transactions, this will query
a <code>000...000</code> transaction to the Electrum server which will return an error and will make the
overall <code>sync()</code> fail.</li></ul> <h3 id="nits-3"><a href="#nits-3" class="header-anchor">#</a> Nits</h3> <ul><li>You cache transactions but not their anchor's validity, which significantly reduces the gains from
caching as you need to make a request for Merkle proofs anyways.</li> <li>In <code>populate_with_txids</code> you state &quot;because of restrictions of the Electrum API, we have to use
the <code>script_get_history</code> call to get confirmation status of our transaction&quot;. But Electrum
supports a <code>verbose</code> parameter to the <code>transaction.get</code> call, which appears to return the number
of confirmations of the transaction. See https://electrumx-spesmilo.readthedocs.io/en/latest/protocol-methods.html#blockchain-transaction-get</li></ul> <h2 id="bdk-wallet"><a href="#bdk-wallet" class="header-anchor">#</a> <code>bdk_wallet</code></h2> <p>TL;DR: untrusted inputs (PSBT, amounts) provided to the public interface should be sanitized before
being used internally.</p> <h3 id="security-risks-4"><a href="#security-risks-4" class="header-anchor">#</a> Security risks</h3> <ul><li>The library will crash on descriptors without an address form, as it assumes it can always get it
but doesn't check it. For instance importing a <code>raw()</code> descriptor would make BDK crash internally.
This can be an issue for a server providing an API to register descriptors and monitor them using
BDK.</li> <li>All across the crate, unchecked arithmetic is used. The unchecked arithmetic rountines of
rust-bitcoin's <code>Amount</code> type will panic if the result of an operation overflows. This is an issue
for externally-provided values, such as for instance recipient amounts or fees.</li> <li><code>Wallet::sign</code>, which could presumably be called with externally-provided PSBTs, calls
<code>update_psbt_with_descriptor</code> which assumes multiple invariants on the PSBT. The PSBT is not
sanity checked beforehand and would therefore make it possible to crash an application using the
library and exposing a sign endpoint. The invariants are assumed in <code>PsbtUtils::get_utxo_for</code>'s
implementation for <code>Psbt</code> (called from <code>update_psbt_with_descriptor</code>): it assumes the inner tx has
at least as many inputs as the PSBT and it assumes that the transaction provided in the PSBT
input's <code>non_witness_utxo</code> field has does contain the output index referenced by the inner
transaction.</li> <li>In <code>build_fee_bump</code> when getting the original utxos the function assumes the previous
transaction's output list does contain the output referred by each input of the transaction to be
bumped. It will crash otherwise. Although it generally holds, it doesn't necessarily.</li> <li>In <code>get_psbt_input</code>, the size of the previous transaction's output vector is similarly assumed,
which could lead to a crash when creating a transaction.</li> <li>In the <code>signer</code> module, the previous transaction contained in a PSBT input is not validated
against the outpoint for legacy and segwit v0 transactions. This is checked when creating a
transaction, but this module may be used to sign a PSBT as an external participant.</li> <li>The descriptor is not checked in <code>Wallet::create_with_params</code> (it only is in <code>load_with_params</code>),
allowing to create a <code>Wallet</code> with an incompatible (multipath, hardened steps, ..) descriptor
which would break a number of invariants during usage of the <code>Wallet</code>.</li> <li>In the transaction builder, <code>current_height</code> will crash on an invalid absolute locktime height. If
<code>None</code> was provided by the caller, this would let a remote chain source crash us by providing at
invalid tip height. But that's considered out of scope. Although it seems unlikely that this
parameter would be exposed to a third party, it's safer to only panic on inconsistent internal
state and not on externally provided inputs.</li> <li>Out of scope since we trust our chain source but the transaction creation code will crash if the
tip's height is not less than 500'000'000 (<code>LockTime::from_height</code> L1305), which could allow a
remote Electrum or Esplora server to crash us.</li></ul> <h3 id="quirks-bugs-2"><a href="#quirks-bugs-2" class="header-anchor">#</a> Quirks / Bugs</h3> <ul><li>You consider unconfirmed coins when creating a transaction, but you do not account for the size of
their ancestors. This can lead to largely underestimating the fees for the transaction, and to
reporting a largely overestimated feerate to the user.</li> <li>In <code>Wallet::load_with_params</code>, <code>change_signers</code> is not set when <code>check_change_descriptor</code> is
<code>None</code>.</li> <li>You create transactions with nVersion set to 1 if no CSV. Nowadays &gt;85% of transactions on the
network are version 2, I think it would make you stick out. It's likely the &lt;15% of version 1
transactions are created by old wallet. It's likely that BDK would be used with newer output
types. If these two assumptions hold, it would make it possible to identify a BDK transaction with
near certainty. Version 2 is also necessary if you want to eventually implement BIP 326
nSequence-based anti-fee-sniping.</li> <li>In <code>create_tx</code>, after <code>fee_amount</code> is used in coin selection it gets assigned new values which end
up never being used.</li> <li>RBF signalling should probably be turned on by default. First because it could be misinterpreted
by users as &quot;this way my transaction has significantly less chances of getting replaced&quot; while
most of the network hashrate runs with full-RBF and from 28.0 it's also the Bitcoin Core default
(nodes will relay replacements for transaction not explicitly signalling RBF). It is also a
fingerprint as around 70% of transactions signal RBF right now, and this number is growing.</li> <li>In <code>finalize_psbt</code>, the code at lines 1910-1911 assumes a PSBT input corresponds to the inner
transaction input. This only holds because it was checked 50 lines before (L1862). It'd be more
careful to use <code>get(n).ok_or(...)?</code> to access the input around line 1910 too, in case the check 50
lines earlier was removed or updated. This is the kind of bug that could slip through review as
it'd affect code outside the diff, and could realistically cause an issue as a PSBT is often
externally provided: it can be reasonably anticipated to be turned into a remote crasher for some
applications.</li> <li><code>Utxo::txout()</code> will crash if <code>prev_tx.output</code> does not contain its prevout. The only place where
a <code>Utxo::Foreign</code> is created without checking whether the outpoint's index is within the bounds of
<code>prev_tx.output</code> is in <code>build_fee_bump</code>, where BDK would have crashed earlier (L1653) if it wasn't
the case.</li> <li>In the SQLite persistence the foreign key constraint from anchor to transactions is not checked.
Adding an anchor for a non-existing transaction will prevent persisting the wallet.</li> <li>The <code>last_seen</code> timestamp (<code>u64</code>) may not fit in SQLite's INTEGER (<code>i64</code>) type. This is not
checked prior to making the SQL request.</li></ul> <h3 id="nits-4"><a href="#nits-4" class="header-anchor">#</a> Nits</h3> <ul><li>When possible to use anti fee-sniping, you always set the current height. All implementations of
anti fee-sniping I'm aware of randomize this by sometimes using a much lower height (typically 100
less) to avoid consistently giving up the height at which a transaction was crafted. I'm not sure
how useful this randomization is, but you might want to consider it. Especially as you already
have a RNG at hand in this function.</li> <li>The doc comment for <code>CoinSelectionAlgorithm::coin_select</code> mentions a non-existing <code>database</code>
parameter.</li> <li>Consistency between descriptor network and chain genesis hash isn't checked in <code>load_with_params</code>
nor in <code>create_with_params</code>.</li> <li>In <code>Wallet::create_tx</code> when the outputs vector of the transaction is empty, you have a comment &quot;We
have a drain_to address and the utxos we must spend (this happens, for example, when we RBF)&quot;
which seems misleading to me. If by &quot;when we RBF&quot; you mean what <code>build_fee_bump</code> does, then it's
incorrect as <code>build_fee_bump</code> won't set <code>params.drain_to</code>.</li> <li><code>TxBuilder::add_data</code> could enforce common standardness rules (max 80 bytes and at most one such
output per transaction). It would also prevent a potential panic to be triggered from within
rust-bitcoin (in <code>push_slice_no_opt</code>) if the data is too large, although I don't think it's
realistic as a request for creating a 4GiB <code>OP_RETURN</code> would probably fail before then.</li></ul> <h2 id="fuzz-targets"><a href="#fuzz-targets" class="header-anchor">#</a> Fuzz targets</h2> <p>These are two fuzz targets that I wrote against Libfuzzer, as integrated by
<a href="https://github.com/rust-fuzz/cargo-fuzz" target="_blank" rel="noopener noreferrer"><code>cargo-fuzz</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, for the purpose of finding issues I can
report.</p> <p>These were not written for the purpose of being shared, but I figured you may find it useful as a
starting point to integrate fuzzing in the BDK project. As such, please pardon the confusing /
debug-quality code there.</p> <h3 id="bdkwalletrs"><a href="#bdkwalletrs" class="header-anchor">#</a> <code>bdkwallet.rs</code></h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> <span class="token namespace">libfuzzer_sys<span class="token punctuation">::</span></span>fuzz_target<span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token namespace">bdk_wallet<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token namespace">hashes<span class="token punctuation">::</span></span><span class="token class-name">Hash</span><span class="token punctuation">,</span> <span class="token namespace">psbt<span class="token punctuation">::</span></span><span class="token class-name">PsbtSighashType</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">chain<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">BlockId</span><span class="token punctuation">,</span> <span class="token class-name">ConfirmationBlockTime</span><span class="token punctuation">,</span> <span class="token class-name">TxUpdate</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token class-name">KeychainKind</span><span class="token punctuation">,</span> <span class="token class-name">SignOptions</span><span class="token punctuation">,</span> <span class="token class-name">TxOrdering</span><span class="token punctuation">,</span> <span class="token class-name">Update</span> <span class="token keyword">as</span> <span class="token class-name">WalletUpdate</span><span class="token punctuation">,</span> <span class="token class-name">Wallet</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">rusqlite<span class="token punctuation">::</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    cmp<span class="token punctuation">,</span>
    <span class="token namespace">collections<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">BTreeMap</span><span class="token punctuation">,</span> <span class="token class-name">BTreeSet</span><span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">,</span> <span class="token class-name">VecDeque</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// TODO: use more complicated descriptors.</span>
<span class="token keyword">const</span> <span class="token constant">EXTERNAL_DESC</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token operator">=</span> <span class="token string">&quot;tr(xprvA1NeLXFV4y3Q3uZERyTp54EyaiRG76DcN3gXzW5bQpjt1JSTnTpi6KS4na6JsZMriWAiVcbePA9RAfNXmrfnXVJj33FvHUFgNNErYPaZE4g/122/1'/0'/0/*)&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">INTERNAL_DESC</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token operator">=</span> <span class="token string">&quot;wpkh(xprv9y5m1SxNcjAY8DJPHqXM67ETRFwpjsacG9xGBiTBMj5A2KupsjuNJuFuFJAzoQJb7fjp3jz78TsmDmqpaTtCBzAKEuqE1NMC3Net5Ma2hY6/84'/1'/0'/1/*)&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">NETWORK</span><span class="token punctuation">:</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">Network</span> <span class="token operator">=</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">Network</span><span class="token punctuation">::</span><span class="token class-name">Bitcoin</span><span class="token punctuation">;</span>

<span class="token keyword">enum</span> <span class="token type-definition class-name">Action</span> <span class="token punctuation">{</span>
    <span class="token class-name">Update</span><span class="token punctuation">,</span>
    <span class="token class-name">Persist</span><span class="token punctuation">,</span>
    <span class="token class-name">TxCreate</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Action</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_byte</span><span class="token punctuation">(</span>byte<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> byte <span class="token operator">==</span> <span class="token number">0x00</span> <span class="token punctuation">{</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Update</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> byte <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Persist</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> byte <span class="token operator">==</span> <span class="token number">0x02</span> <span class="token punctuation">{</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">TxCreate</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">None</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">UniqueHash</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">;</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">UniqueHash</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">32</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">;</span> <span class="token number">32</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> byte <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token operator">*</span>byte <span class="token operator">&lt;</span> <span class="token keyword">u8</span><span class="token punctuation">::</span><span class="token constant">MAX</span> <span class="token punctuation">{</span>
                <span class="token operator">*</span>byte <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>data
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_block_hash</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">BlockHash</span> <span class="token punctuation">{</span>
        <span class="token namespace">bitcoin<span class="token punctuation">::</span>hash_types<span class="token punctuation">::</span></span><span class="token class-name">BlockHash</span><span class="token punctuation">::</span><span class="token function">from_byte_array</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_txid</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">Txid</span> <span class="token punctuation">{</span>
        <span class="token namespace">bitcoin<span class="token punctuation">::</span>hash_types<span class="token punctuation">::</span></span><span class="token class-name">Txid</span><span class="token punctuation">::</span><span class="token function">from_byte_array</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token macro property">macro_rules!</span> next_or_return <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token variable">$iter</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token variable">$iter</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> val<span class="token punctuation">,</span>
            <span class="token class-name">None</span> <span class="token operator">=&gt;</span> <span class="token keyword">return</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">scale</span><span class="token punctuation">(</span>byte<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u32</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>byte <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x01000000</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">scale_u64</span><span class="token punctuation">(</span>byte<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u64</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>byte <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x0100000000000000</span>
<span class="token punctuation">}</span>

<span class="token macro property">fuzz_target!</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> data_iter <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> conn <span class="token operator">=</span> <span class="token class-name">Connection</span><span class="token punctuation">::</span><span class="token function">open_in_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> wallet <span class="token operator">=</span> <span class="token class-name">Wallet</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token constant">EXTERNAL_DESC</span><span class="token punctuation">,</span> <span class="token constant">INTERNAL_DESC</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">network</span><span class="token punctuation">(</span><span class="token constant">NETWORK</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">create_wallet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> conn<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> unique_hash <span class="token operator">=</span> <span class="token class-name">UniqueHash</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> unconfirmed_txids <span class="token operator">=</span> <span class="token class-name">VecDeque</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Exercise the Wallet logic based on the fuzzer's input.</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> action <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">Action</span><span class="token punctuation">::</span><span class="token function">from_byte</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            a
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">match</span> action <span class="token punctuation">{</span>
            <span class="token class-name">Action</span><span class="token punctuation">::</span><span class="token class-name">Update</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// Start with active indices.</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> last_active_indices <span class="token operator">=</span> <span class="token class-name">BTreeMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> indices_count <span class="token operator">=</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> index_start <span class="token operator">=</span> <span class="token function">scale</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    last_active_indices
                        <span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">(</span>index_start<span class="token punctuation">..</span>indices_count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>i<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">(</span><span class="token class-name">KeychainKind</span><span class="token punctuation">::</span><span class="token class-name">Internal</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> indices_count <span class="token operator">=</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> index_start <span class="token operator">=</span> <span class="token function">scale</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    last_active_indices
                        <span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">(</span>index_start<span class="token punctuation">..</span>indices_count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>i<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">(</span><span class="token class-name">KeychainKind</span><span class="token punctuation">::</span><span class="token class-name">External</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// Now do the transaction graph update.</span>
                <span class="token comment">// TODO: more edge cases, eg coinbase txs.</span>
                <span class="token keyword">let</span> txs_count <span class="token operator">=</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> txs <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>txs_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>txs_count <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> version <span class="token operator">=</span> <span class="token function">scale</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">i32</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> version <span class="token operator">=</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span>transaction<span class="token punctuation">::</span></span><span class="token class-name">Version</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> lock_time <span class="token operator">=</span> <span class="token function">scale</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> lock_time <span class="token operator">=</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span>absolute<span class="token punctuation">::</span></span><span class="token class-name">LockTime</span><span class="token punctuation">::</span><span class="token function">from_consensus</span><span class="token punctuation">(</span>lock_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> txin_count <span class="token operator">=</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> <span class="token keyword">mut</span> input <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>txin_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>txin_count <span class="token punctuation">{</span>
                        <span class="token keyword">let</span> previous_output <span class="token operator">=</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">OutPoint</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
                            unique_hash<span class="token punctuation">.</span><span class="token function">get_txid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                        input<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">TxIn</span> <span class="token punctuation">{</span>
                            previous_output<span class="token punctuation">,</span>
                            <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">let</span> txout_count <span class="token operator">=</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> <span class="token keyword">mut</span> output <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>txout_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>txout_count <span class="token punctuation">{</span>
                        <span class="token keyword">let</span> script_pubkey <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                            wallet
                                <span class="token punctuation">.</span><span class="token function">next_unused_address</span><span class="token punctuation">(</span><span class="token class-name">KeychainKind</span><span class="token punctuation">::</span><span class="token class-name">External</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">script_pubkey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                            wallet
                                <span class="token punctuation">.</span><span class="token function">next_unused_address</span><span class="token punctuation">(</span><span class="token class-name">KeychainKind</span><span class="token punctuation">::</span><span class="token class-name">Internal</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">script_pubkey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">ScriptBuf</span><span class="token punctuation">::</span><span class="token function">from_bytes</span><span class="token punctuation">(</span>unique_hash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> amount <span class="token operator">=</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span> <span class="token operator">*</span> <span class="token number">1_000</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">Amount</span><span class="token punctuation">::</span><span class="token function">from_sat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        output<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">TxOut</span> <span class="token punctuation">{</span>
                            value<span class="token punctuation">,</span>
                            script_pubkey<span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">let</span> tx <span class="token operator">=</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">Transaction</span> <span class="token punctuation">{</span>
                        version<span class="token punctuation">,</span>
                        lock_time<span class="token punctuation">,</span>
                        input<span class="token punctuation">,</span>
                        output<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    unconfirmed_txids<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">compute_txid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    txs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">let</span> txouts_count <span class="token operator">=</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> txouts <span class="token operator">=</span> <span class="token class-name">BTreeMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>txouts_count <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> outpoint <span class="token operator">=</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">OutPoint</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
                        unique_hash<span class="token punctuation">.</span><span class="token function">get_txid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> amount <span class="token operator">=</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span> <span class="token operator">*</span> <span class="token number">1_000</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">Amount</span><span class="token punctuation">::</span><span class="token function">from_sat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    txouts<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>
                        outpoint<span class="token punctuation">,</span>
                        <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">TxOut</span> <span class="token punctuation">{</span>
                            value<span class="token punctuation">,</span>
                            script_pubkey<span class="token punctuation">:</span> <span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">let</span> <span class="token keyword">mut</span> anchors <span class="token operator">=</span> <span class="token class-name">BTreeSet</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> height <span class="token operator">=</span> <span class="token function">scale</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> hash <span class="token operator">=</span> unique_hash<span class="token punctuation">.</span><span class="token function">get_block_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> block_id <span class="token operator">=</span> <span class="token class-name">BlockId</span> <span class="token punctuation">{</span> height<span class="token punctuation">,</span> hash <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> confirmation_time <span class="token operator">=</span> <span class="token function">scale_u64</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> anchor <span class="token operator">=</span> <span class="token class-name">ConfirmationBlockTime</span> <span class="token punctuation">{</span>
                        block_id<span class="token punctuation">,</span>
                        confirmation_time<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token comment">// FIXME: inserting anchors for transactions not in the tx graph will fail the</span>
                    <span class="token comment">// SQLite persistence.</span>
                    <span class="token comment">//let txid = unconfirmed_txids</span>
                    <span class="token comment">//.pop_front()</span>
                    <span class="token comment">//.unwrap_or(unique_hash.get_txid());</span>
                    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>txid<span class="token punctuation">)</span> <span class="token operator">=</span> unconfirmed_txids<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        anchors<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> txid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">let</span> <span class="token keyword">mut</span> seen_ats <span class="token operator">=</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> time <span class="token operator">=</span>
                        <span class="token namespace">cmp<span class="token punctuation">::</span></span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">scale_u64</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">i64</span><span class="token punctuation">::</span><span class="token constant">MAX</span> <span class="token keyword">as</span> <span class="token keyword">u64</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> txid <span class="token operator">=</span> unconfirmed_txids
                        <span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">unwrap_or</span><span class="token punctuation">(</span>unique_hash<span class="token punctuation">.</span><span class="token function">get_txid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    seen_ats<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>txid<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">let</span> tx_update <span class="token operator">=</span> <span class="token class-name">TxUpdate</span> <span class="token punctuation">{</span>
                    txs<span class="token punctuation">,</span>
                    txouts<span class="token punctuation">,</span>
                    anchors<span class="token punctuation">,</span>
                    seen_ats<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token comment">// Finally, do the chain update.</span>
                <span class="token comment">// TODO: sometimes generate invalid updates, reorgs, etc.</span>
                <span class="token keyword">let</span> chain <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> <span class="token keyword">mut</span> tip <span class="token operator">=</span> wallet<span class="token punctuation">.</span><span class="token function">latest_checkpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> tip_height <span class="token operator">=</span> tip<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> blocks_count <span class="token operator">=</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span>blocks_count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">{</span>
                        tip <span class="token operator">=</span> tip
                            <span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">BlockId</span> <span class="token punctuation">{</span>
                                height<span class="token punctuation">:</span> tip_height <span class="token operator">+</span> i<span class="token punctuation">,</span>
                                hash<span class="token punctuation">:</span> unique_hash<span class="token punctuation">.</span><span class="token function">get_block_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">Some</span><span class="token punctuation">(</span>tip<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">None</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token comment">// The Wallet update should never fail as we only ever create a consistent chain.</span>
                <span class="token keyword">let</span> update <span class="token operator">=</span> <span class="token class-name">WalletUpdate</span> <span class="token punctuation">{</span>
                    last_active_indices<span class="token punctuation">,</span>
                    tx_update<span class="token punctuation">,</span>
                    chain<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                wallet<span class="token punctuation">.</span><span class="token function">apply_update</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Assert the wallet roundtrips to persistence and check some invariants.</span>
            <span class="token class-name">Action</span><span class="token punctuation">::</span><span class="token class-name">Persist</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> balance_before <span class="token operator">=</span> wallet<span class="token punctuation">.</span><span class="token function">balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> next_indices_before <span class="token operator">=</span> <span class="token punctuation">(</span>
                    wallet<span class="token punctuation">.</span><span class="token function">next_derivation_index</span><span class="token punctuation">(</span><span class="token class-name">KeychainKind</span><span class="token punctuation">::</span><span class="token class-name">Internal</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    wallet<span class="token punctuation">.</span><span class="token function">next_derivation_index</span><span class="token punctuation">(</span><span class="token class-name">KeychainKind</span><span class="token punctuation">::</span><span class="token class-name">External</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> tip_before <span class="token operator">=</span> wallet<span class="token punctuation">.</span><span class="token function">latest_checkpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                wallet
                    <span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> conn<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;We should always be able to persist.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> expected_genesis <span class="token operator">=</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">BlockHash</span><span class="token punctuation">::</span><span class="token function">from_slice</span><span class="token punctuation">(</span>
                    <span class="token namespace">bitcoin<span class="token punctuation">::</span>blockdata<span class="token punctuation">::</span>constants<span class="token punctuation">::</span></span><span class="token class-name">ChainHash</span><span class="token punctuation">::</span><span class="token constant">BITCOIN</span><span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                wallet <span class="token operator">=</span> <span class="token class-name">Wallet</span><span class="token punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">descriptor</span><span class="token punctuation">(</span><span class="token class-name">KeychainKind</span><span class="token punctuation">::</span><span class="token class-name">Internal</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token constant">INTERNAL_DESC</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">descriptor</span><span class="token punctuation">(</span><span class="token class-name">KeychainKind</span><span class="token punctuation">::</span><span class="token class-name">External</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token constant">EXTERNAL_DESC</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">check_network</span><span class="token punctuation">(</span><span class="token constant">NETWORK</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">check_genesis_hash</span><span class="token punctuation">(</span>expected_genesis<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">load_wallet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> conn<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;We should always be able to load back from persistence.&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Must exist as it was persisted just now.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>wallet<span class="token punctuation">.</span><span class="token function">balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> balance_before<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> next_indices_after <span class="token operator">=</span> <span class="token punctuation">(</span>
                    wallet<span class="token punctuation">.</span><span class="token function">next_derivation_index</span><span class="token punctuation">(</span><span class="token class-name">KeychainKind</span><span class="token punctuation">::</span><span class="token class-name">Internal</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    wallet<span class="token punctuation">.</span><span class="token function">next_derivation_index</span><span class="token punctuation">(</span><span class="token class-name">KeychainKind</span><span class="token punctuation">::</span><span class="token class-name">External</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>next_indices_after<span class="token punctuation">,</span> next_indices_before<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>wallet<span class="token punctuation">.</span><span class="token function">latest_checkpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tip_before<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Action</span><span class="token punctuation">::</span><span class="token class-name">TxCreate</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> utxo <span class="token operator">=</span> wallet<span class="token punctuation">.</span><span class="token function">list_unspent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> change_address <span class="token operator">=</span> wallet<span class="token punctuation">.</span><span class="token function">next_unused_address</span><span class="token punctuation">(</span><span class="token class-name">KeychainKind</span><span class="token punctuation">::</span><span class="token class-name">Internal</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> receive_address <span class="token operator">=</span> wallet<span class="token punctuation">.</span><span class="token function">next_unused_address</span><span class="token punctuation">(</span><span class="token class-name">KeychainKind</span><span class="token punctuation">::</span><span class="token class-name">External</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">let</span> <span class="token keyword">mut</span> tx_builder <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    wallet<span class="token punctuation">.</span><span class="token function">build_tx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// TODO: be smarter, don't always pick the first one, sometimes pick a</span>
                    <span class="token comment">// canonical one.</span>
                    <span class="token keyword">let</span> txid <span class="token operator">=</span> wallet<span class="token punctuation">.</span><span class="token function">tx_graph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">full_txs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>tx<span class="token closure-punctuation punctuation">|</span></span> tx<span class="token punctuation">.</span>txid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>txid<span class="token punctuation">)</span> <span class="token operator">=</span> txid <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span> <span class="token operator">=</span> wallet<span class="token punctuation">.</span><span class="token function">build_fee_bump</span><span class="token punctuation">(</span>txid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            builder
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> <span class="token keyword">mut</span> rate <span class="token operator">=</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                        rate <span class="token operator">*=</span> <span class="token number">1_000</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">let</span> rate <span class="token operator">=</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">FeeRate</span><span class="token punctuation">::</span><span class="token function">from_sat_per_vb</span><span class="token punctuation">(</span>rate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;within range.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">fee_rate</span><span class="token punctuation">(</span>rate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token comment">// FIXME: this can't be * 100 as as I initially set it to be as rust-bitcoin</span>
                    <span class="token comment">// panics internally on overflowing Amount additions.</span>
                    <span class="token keyword">let</span> <span class="token keyword">mut</span> fee <span class="token operator">=</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                        fee <span class="token operator">*=</span> <span class="token number">1_000</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">let</span> fee <span class="token operator">=</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">Amount</span><span class="token punctuation">::</span><span class="token function">from_sat</span><span class="token punctuation">(</span>fee<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">fee_absolute</span><span class="token punctuation">(</span>fee<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> utxo<span class="token punctuation">)</span> <span class="token operator">=</span> utxo <span class="token punctuation">{</span>
                        tx_builder<span class="token punctuation">.</span><span class="token function">add_utxo</span><span class="token punctuation">(</span>utxo<span class="token punctuation">.</span>outpoint<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;known utxo.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// TODO: add foreign utxo</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">manually_selected_only</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> utxo<span class="token punctuation">)</span> <span class="token operator">=</span> utxo <span class="token punctuation">{</span>
                        tx_builder<span class="token punctuation">.</span><span class="token function">add_unspendable</span><span class="token punctuation">(</span>utxo<span class="token punctuation">.</span>outpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> sighash <span class="token operator">=</span> <span class="token class-name">PsbtSighashType</span><span class="token punctuation">::</span><span class="token function">from_u32</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">sighash</span><span class="token punctuation">(</span>sighash<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> ordering <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                        <span class="token class-name">TxOrdering</span><span class="token punctuation">::</span><span class="token class-name">Shuffle</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token class-name">TxOrdering</span><span class="token punctuation">::</span><span class="token class-name">Untouched</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">ordering</span><span class="token punctuation">(</span>ordering<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> lock_time <span class="token operator">=</span> <span class="token function">scale</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> lock_time <span class="token operator">=</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span>absolute<span class="token punctuation">::</span></span><span class="token class-name">LockTime</span><span class="token punctuation">::</span><span class="token function">from_consensus</span><span class="token punctuation">(</span>lock_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">nlocktime</span><span class="token punctuation">(</span>lock_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> version <span class="token operator">=</span> <span class="token function">scale</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">i32</span><span class="token punctuation">;</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">do_not_spend_change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">only_spend_change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">only_witness_utxo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">include_output_redeem_witness_script</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">add_global_xpubs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">drain_wallet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">enable_rbf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">allow_dust</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> recipients_count <span class="token operator">=</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> <span class="token keyword">mut</span> recipients <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>recipients_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>recipients_count <span class="token punctuation">{</span>
                        <span class="token keyword">let</span> spk <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                            <span class="token keyword">let</span> spk_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                            <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">ScriptBuf</span><span class="token punctuation">::</span><span class="token function">from_bytes</span><span class="token punctuation">(</span>unique_hash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">..</span>spk_size<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                            change_address<span class="token punctuation">.</span><span class="token function">script_pubkey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            receive_address<span class="token punctuation">.</span><span class="token function">script_pubkey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> amount <span class="token operator">=</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span> <span class="token operator">*</span> <span class="token number">1_000</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> amount <span class="token operator">=</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">Amount</span><span class="token punctuation">::</span><span class="token function">from_sat</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        recipients<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>spk<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    tx_builder<span class="token punctuation">.</span><span class="token function">set_recipients</span><span class="token punctuation">(</span>recipients<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// TODO: add data</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> spk <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                        <span class="token keyword">let</span> spk_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">ScriptBuf</span><span class="token punctuation">::</span><span class="token function">from_bytes</span><span class="token punctuation">(</span>unique_hash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">..</span>spk_size<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                        change_address<span class="token punctuation">.</span><span class="token function">script_pubkey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        receive_address<span class="token punctuation">.</span><span class="token function">script_pubkey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    tx_builder<span class="token punctuation">.</span><span class="token function">drain_to</span><span class="token punctuation">(</span>spk<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">let</span> <span class="token keyword">mut</span> psbt <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token operator">=</span> tx_builder<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    tx
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> sign_options <span class="token operator">=</span> <span class="token class-name">SignOptions</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    sign_options<span class="token punctuation">.</span>trust_witness_utxo <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> height <span class="token operator">=</span> <span class="token function">scale</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    sign_options<span class="token punctuation">.</span>assume_height <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    sign_options<span class="token punctuation">.</span>allow_all_sighashes <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    sign_options<span class="token punctuation">.</span>try_finalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    sign_options<span class="token punctuation">.</span>tap_leaves_options <span class="token operator">=</span> <span class="token namespace">bdk_wallet<span class="token punctuation">::</span>signer<span class="token punctuation">::</span></span><span class="token class-name">TapLeavesOptions</span><span class="token punctuation">::</span><span class="token class-name">None</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    sign_options<span class="token punctuation">.</span>sign_with_tap_internal_key <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">{</span>
                    sign_options<span class="token punctuation">.</span>allow_grinding <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> wallet<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> psbt<span class="token punctuation">,</span> sign_options<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// If after all this we managed to create and fully sign a valid transaction, add</span>
                <span class="token comment">// it to the wallet.</span>
                <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>finalized<span class="token punctuation">)</span> <span class="token operator">=</span> wallet<span class="token punctuation">.</span><span class="token function">finalize_psbt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> psbt<span class="token punctuation">,</span> sign_options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> finalized <span class="token punctuation">{</span>
                        <span class="token keyword">let</span> tx <span class="token operator">=</span> <span class="token keyword">match</span> psbt<span class="token punctuation">.</span><span class="token function">extract_tx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                                <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token macro property">matches!</span><span class="token punctuation">(</span>
                                    e<span class="token punctuation">,</span>
                                    <span class="token namespace">bitcoin<span class="token punctuation">::</span>psbt<span class="token punctuation">::</span></span><span class="token class-name">ExtractTxError</span><span class="token punctuation">::</span><span class="token class-name">AbsurdFeeRate</span> <span class="token punctuation">{</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span>
                                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token class-name">Ok</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> tx<span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> <span class="token keyword">mut</span> wallet_update <span class="token operator">=</span> <span class="token class-name">WalletUpdate</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        wallet_update<span class="token punctuation">.</span>tx_update<span class="token punctuation">.</span>txs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        wallet<span class="token punctuation">.</span><span class="token function">apply_update</span><span class="token punctuation">(</span>wallet_update<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="merge-chainsrs"><a href="#merge-chainsrs" class="header-anchor">#</a> <code>merge_chains.rs</code></h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#![no_main]</span>

<span class="token keyword">use</span> <span class="token namespace">bdk_chain<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token namespace">hashes<span class="token punctuation">::</span></span><span class="token class-name">Hash</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">local_chain<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">ChangeSet</span><span class="token punctuation">,</span> <span class="token class-name">LocalChain</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token class-name">CheckPoint</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">libfuzzer_sys<span class="token punctuation">::</span></span>fuzz_target<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    cmp<span class="token punctuation">,</span>
    <span class="token namespace">collections<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">BTreeMap</span><span class="token punctuation">,</span> <span class="token class-name">BTreeSet</span><span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">,</span> <span class="token class-name">VecDeque</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">UniqueHash</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">;</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">UniqueHash</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">32</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">;</span> <span class="token number">32</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> byte <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token operator">*</span>byte <span class="token operator">&lt;</span> <span class="token keyword">u8</span><span class="token punctuation">::</span><span class="token constant">MAX</span> <span class="token punctuation">{</span>
                <span class="token operator">*</span>byte <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>data
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_block_hash</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span></span><span class="token class-name">BlockHash</span> <span class="token punctuation">{</span>
        <span class="token namespace">bitcoin<span class="token punctuation">::</span>hash_types<span class="token punctuation">::</span></span><span class="token class-name">BlockHash</span><span class="token punctuation">::</span><span class="token function">from_byte_array</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token macro property">macro_rules!</span> next_or_return <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token variable">$iter</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token variable">$iter</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> val<span class="token punctuation">,</span>
            <span class="token class-name">None</span> <span class="token operator">=&gt;</span> <span class="token keyword">return</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">is_odd</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
    n <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token operator">==</span> <span class="token number">0x01</span>
<span class="token punctuation">}</span>

<span class="token macro property">fuzz_target!</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> data <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> unique_hashes <span class="token operator">=</span> <span class="token class-name">UniqueHash</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// First create an initial, valid, chain.</span>
    <span class="token comment">// TODO: scale chain size to a few thousands.</span>
    <span class="token keyword">let</span> initial_chain_len <span class="token operator">=</span> <span class="token namespace">cmp<span class="token punctuation">::</span></span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> initial_blocks <span class="token operator">=</span> <span class="token class-name">BTreeMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    initial_blocks<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>unique_hashes<span class="token punctuation">.</span><span class="token function">get_block_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span>initial_chain_len <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token function">is_odd</span><span class="token punctuation">(</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            initial_blocks<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>
                i<span class="token punctuation">,</span>
                <span class="token function">is_odd</span><span class="token punctuation">(</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then_some</span><span class="token punctuation">(</span>unique_hashes<span class="token punctuation">.</span><span class="token function">get_block_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> height <span class="token operator">=</span> <span class="token namespace">cmp<span class="token punctuation">::</span></span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            initial_blocks<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>
                height<span class="token punctuation">,</span>
                <span class="token function">is_odd</span><span class="token punctuation">(</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then_some</span><span class="token punctuation">(</span>unique_hashes<span class="token punctuation">.</span><span class="token function">get_block_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> initial_chain <span class="token operator">=</span> <span class="token class-name">LocalChain</span><span class="token punctuation">::</span><span class="token function">from_changeset</span><span class="token punctuation">(</span><span class="token class-name">ChangeSet</span> <span class="token punctuation">{</span>
        blocks<span class="token punctuation">:</span> initial_blocks<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;A genesis block is always present.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> initial_chain_height <span class="token operator">=</span> initial_chain<span class="token punctuation">.</span><span class="token function">tip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Now create another chain to be merged with the initial one. Sometimes extend the initial</span>
    <span class="token comment">// chain, sometimes not, depending on the fuzzer's input.</span>
    <span class="token comment">// TODO: sometimes add some hashes from the initial chain in the update chain.</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> connects <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> reorg_height <span class="token operator">=</span> <span class="token class-name">None</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> update_chain_len <span class="token operator">=</span> <span class="token namespace">cmp<span class="token punctuation">::</span></span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> height<span class="token punctuation">,</span> <span class="token keyword">mut</span> update_cp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token function">is_odd</span><span class="token punctuation">(</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>
            <span class="token namespace">cmp<span class="token punctuation">::</span></span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">CheckPoint</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> initial_chain<span class="token punctuation">.</span><span class="token function">genesis_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        connects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span>
            initial_chain_height <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token class-name">CheckPoint</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>initial_chain<span class="token punctuation">.</span><span class="token function">tip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>update_chain_len <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">{</span>
        height <span class="token operator">+=</span> <span class="token keyword">if</span> <span class="token function">is_odd</span><span class="token punctuation">(</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span><span class="token macro property">next_or_return!</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> hash <span class="token operator">=</span> unique_hashes<span class="token punctuation">.</span><span class="token function">get_block_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        update_cp <span class="token operator">=</span> update_cp
            <span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Height is always increasing.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// BDK requires that the block right after the point of agreement in the initial chain be</span>
        <span class="token comment">// included in the original chain for it to connect. We check if this block is this &quot;first</span>
        <span class="token comment">// block to conflict&quot; by:</span>
        <span class="token comment">// 1) Checking it is at all in the initial chain</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>connects <span class="token operator">&amp;&amp;</span> initial_blocks<span class="token punctuation">.</span><span class="token function">contains_key</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2) Checking it does indeed conflict with the block in the initial chain.</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span>conflict_h<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> initial_blocks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> hash <span class="token operator">!=</span> <span class="token operator">*</span>conflict_h <span class="token punctuation">{</span>
                    <span class="token comment">// 3) Checking the block right before is the point of agreement.</span>
                    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> prev<span class="token punctuation">)</span> <span class="token operator">=</span> update_cp<span class="token punctuation">.</span><span class="token function">prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span>agree_h<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> initial_blocks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>prev<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> prev<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">*</span>agree_h <span class="token punctuation">{</span>
                                <span class="token comment">// 4) Checking the block right after the point of agreement in the</span>
                                <span class="token comment">//    initial chain is indeed at the height of our conflict block.</span>
                                <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>initial_agree_h<span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span>
                                    initial_blocks<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>prev<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">{</span>
                                    <span class="token keyword">if</span> <span class="token operator">*</span>initial_agree_h <span class="token operator">==</span> height <span class="token punctuation">{</span>
                                        <span class="token comment">//eprintln!(&quot;Connects&quot;);</span>
                                        connects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                        reorg_height <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        height <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//dbg!(&amp;initial_chain);</span>
    <span class="token comment">//dbg!(&amp;update_cp);</span>
    <span class="token keyword">let</span> merge_res <span class="token operator">=</span> initial_chain<span class="token punctuation">.</span><span class="token function">apply_update</span><span class="token punctuation">(</span>update_cp<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> connects <span class="token punctuation">{</span>
        <span class="token comment">//dbg!(&amp;merge_res);</span>
        <span class="token keyword">let</span> merge_res <span class="token operator">=</span> merge_res<span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Must only fail if it cannot connect.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> new_chain_height <span class="token operator">=</span> update_cp<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// All blocks in the update but the very first must have been recorded as newly added, no</span>
        <span class="token comment">// matter if it was extending or reorg'ing the chain.</span>
        <span class="token keyword">loop</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>cp<span class="token punctuation">)</span> <span class="token operator">=</span> update_cp<span class="token punctuation">.</span><span class="token function">prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> update_hash <span class="token operator">=</span> merge_res
                    <span class="token punctuation">.</span>blocks
                    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>update_cp<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Must contain all blocks from update.&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Must be an added block.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>update_cp<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> update_hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
                update_cp <span class="token operator">=</span> cp<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// If the update chain is smaller than the initial block, all blocks in the initial chain</span>
        <span class="token comment">// whose height is higher than the update's tip must have been recorded as dropped.</span>
        <span class="token keyword">if</span> new_chain_height <span class="token operator">&lt;</span> initial_chain_height <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span> reorg_height <span class="token punctuation">{</span>
                <span class="token macro property">assert!</span><span class="token punctuation">(</span>merge_res
                    <span class="token punctuation">.</span>blocks
                    <span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>new_chain_height <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>entry<span class="token closure-punctuation punctuation">|</span></span> entry<span class="token number">.1</span><span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/bitcoindevkit/bitcoindevkit.org/edit/master/docs/audits/2024_q4/bdk_audit_report.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/18/2025, 2:23:14 PM</span></div></footer> <!----> </main></div></div> <footer class="footer" data-v-b812d5fc><div class="wrap"><div class="wrap-border"><div class="inner"><div class="footer-content"><div class="footer-block"><h4>Docs</h4> <div><a href="/docs/#book" class="nav-link">
  Book
</a></div><div><a href="/docs/#rust-apis" class="nav-link">
  Rust APIs
</a></div><div><a href="/docs/#other-apis" class="nav-link">
  Other APIs
</a></div></div><div class="footer-block"><h4>Community</h4> <div><a href="https://github.com/bitcoindevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div><a href="nostr:npub13dk3dke4zm9vdkucm7f6vv7vhqgkevgg3gju9kr2wzumz7nrykdq0dgnvc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nostr
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div><a href="https://twitter.com/intent/follow?screen_name=bitcoindevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Twitter
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div><a href="https://discord.gg/dstn4dQ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Chat on Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></div><div class="footer-block"><h4>More</h4> <div><a href="/blog/" class="nav-link">
  Blog
</a></div><div><a href="/foundation/supporters/" class="nav-link">
  Supporters
</a></div><div><a href="/foundation/" class="nav-link">
  BDK Foundation
</a></div></div></div> <p class="copyright">Copyright ¬© 2025 BDK Developers</p></div></div></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3bab8f60.js" defer></script><script src="/assets/js/3.80705bfd.js" defer></script><script src="/assets/js/1.5c570f52.js" defer></script><script src="/assets/js/88.37800373.js" defer></script>
  </body>
</html>
